<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>メモリープロ - 記憶術マスター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overscroll-behavior-y: contain;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #root { height: 100%; width: 100%; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes countdown-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-countdown { animation: countdown-pulse 1s ease-in-out infinite; }
        
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import confetti from 'https://esm.sh/canvas-confetti@1.6.0';

        // --- Data Definitions ---
        const DEFAULT_LETTER_MASTER = {
            'あ': { 'いう': 'EU', 'いえ': '家', 'いか': 'イカ', 'いき': '息', 'いく': 'イクラ', 'いけ': 'イケメン', 'いさ': '居酒屋', 'いし': '石', 'いす': '椅子', 'うい': 'ウインナー', 'うえ': 'ウエハース', 'うか': '羽化', 'うき': '浮き輪', 'うく': 'ウクライナ', 'うけ': '受付', 'うさ': 'うさぎ', 'うし': '牛', 'うす': '臼', 'えい': 'エイ', 'えう': 'AU', 'えか': 'エガちゃん', 'えき': '駅', 'えく': 'えくぼ', 'えけ': 'AKB', 'えさ': '餌', 'えし': '壊死', 'えす': 'エスカレーター' },
            'か': { 'かい': '貝', 'かう': 'カウボーイ', 'かえ': 'カエル', 'かき': '牡蠣', 'かく': '核', 'かけ': '影', 'かさ': '傘', 'かし': '火事', 'かす': '春日', 'きい': '黄色', 'きう': 'キウイ', 'きえ': '松本きえ', 'きか': '機械', 'きく': 'きくらげ', 'きけ': '危険', 'きさ': '喫茶店', 'きし': '騎士', 'きす': '傷', 'くい': 'クイナ', 'くう': 'Qoo', 'くえ': 'クエ', 'くか': '空海', 'くき': 'クッキー', 'くけ': '公家', 'くさ': '草', 'くし': '櫛', 'くす': 'くす玉', 'けい': 'ゲイ', 'けう': '今日', 'けえ': 'ゲーム', 'けか': '外科医', 'けき': '劇', 'けく': 'ケイク', 'けさ': '袈裟固め', 'けし': '化粧', 'けす': 'ゲス極' },
            'さ': { 'さい': 'サイ', 'さう': 'サウナ', 'さえ': '紗恵', 'さか': 'サッカー', 'さき': '詐欺', 'さく': '桜', 'さけ': '酒', 'さし': 'サッシー', 'さす': 'サスケ', 'しい': '椎名林檎', 'しう': 'しゅうまい', 'しえ': 'シェー', 'しか': 'シカ', 'しき': '指揮', 'しく': 'しくしく', 'しけ': '死刑', 'しさ': 'シーサー', 'しす': 'シス研', 'すい': 'スイカ', 'すう': '数学', 'すえ': '末広課長', 'すか': 'スカイツリー', 'すき': 'スキー', 'すく': 'スク水', 'すけ': 'スケート', 'すさ': 'スザンヌ', 'すし': '寿司', 'せい': '精子', 'せう': 'ゼウス', 'せえ': 'セールス', 'せか': 'セカオワ', 'せき': '咳', 'せく': 'セクハラ', 'せけ': '石鹸', 'せさ': 'セサミストリート', 'せし': 'セシウム', 'せす': 'セスナ' },
            'た': { 'たい': '鯛', 'たう': '田植え', 'たえ': '耐える', 'たカ': '鷹', 'たき': '滝', 'たく': 'タクシー', 'たけ': 'タケノコ', 'たさ': 'ターザン', 'たし': '出汁', 'たす': 'TAS', 'ちい': 'ちいかわ', 'ちう': 'チューリップ', 'ちえ': '知恵袋', 'ちか': '痴漢', 'ちき': 'チキン', 'ちく': '乳首', 'ちけ': 'チケット', 'ちし': '知事', 'ちす': 'チーズ', 'てい': '手越', 'てう': '手打ちうどん', 'てえ': 'テープ', 'てか': '手鏡', 'てき': 'テキーラ', 'てく': '手首', 'てけ': 'テケテケ', 'てさ': 'テーザー銃', 'てし': '手品', 'てす': 'テスト' },
            'な': { 'にい': '新居', 'にう': 'NEW', 'にえ': '三重', 'にか': 'ニカ', 'にき': 'ニキビ', 'にく': '肉', 'にけ': 'ニケ', 'にさ': 'NISA', 'にし': 'にっしー', 'にす': 'ニス', 'ぬい': 'ぬいぐるみ', 'ぬう': 'King Gnu', 'ぬえ': 'ぬえ', 'ぬか': 'ぬか漬け', 'ぬき': '抜き', 'ぬく': '温水', 'ぬけ': '抜け毛', 'ぬさ': 'ムササビ', 'ぬし': '主', 'ぬす': '盗人', 'ねい': 'ネイマール', 'ねう': '値打ち', 'ねえ': '姉さん', 'ねか': 'ネカフェ', 'ねき': 'ネギ', 'ねく': 'ネクタイ', 'ねけ': '練り消し', 'ねさ': 'ネザー', 'ねし': 'ネッシー', 'ねす': 'ネス' },
            'は': { 'はい': '肺', 'はう': 'はうはる', 'はえ': 'ハエ', 'はか': '墓', 'はき': '覇気', 'はく': '吐く', 'はけ': 'ハゲ', 'はさ': 'ハサミ', 'はし': '橋', 'はす': '蓮見クレア', 'ひい': 'ひいおばあちゃん', 'ひう': '火打ち石', 'ひえ': 'ピエロ', 'ひか': 'ヒカキン', 'ひき': 'ひきこもり', 'ひく': 'ピクミン', 'ひけ': 'ひげ', 'ひさ': 'ピザ', 'ひし': '秘書', 'ひす': '翡翠', 'ふい': '南くん', 'ふう': '風船', 'ふえ': '笛', 'ふか': '深キョン', 'ふき': '吹き矢', 'ふく': 'フグ', 'ふけ': 'ふけ', 'ふさ': 'ブサイク', 'ふし': '富士山', 'ふす': '襖', 'へい': 'ヘイホー', 'へう': 'ヘリウム', 'へえ': 'ベーコン', 'へか': 'PEKKA', 'へき': 'ベッキー', 'へく': 'ベクター', 'へけ': 'ぺけたん', 'へさ': '偏差値', 'へし': 'ヘッショ', 'へす': 'ベス' }
        };

        const SUITS = ['spade', 'heart', 'diamond', 'club'];
        const SUIT_ICONS = { spade: '♠', heart: '♥', diamond: '♦', club: '♣' };
        const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

        const formatTime = (ms) => {
            const totalSeconds = ms / 1000;
            const m = Math.floor(totalSeconds / 60);
            const s = (totalSeconds % 60).toFixed(2);
            return `${m}:${s.padStart(5, '0')}`;
        };

        const getJapaneseEra = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const fullDate = year * 10000 + month * 100 + day;
            if (fullDate >= 20190501) return `令和${year - 2018 === 1 ? '元' : year - 2018}年`;
            if (fullDate >= 19890108) return `平成${year - 1988 === 1 ? '元' : year - 1988}年`;
            if (fullDate >= 19261225) return `昭和${year - 1925 === 1 ? '元' : year - 1925}年`;
            if (fullDate >= 19120730) return `大正${year - 1911 === 1 ? '元' : year - 1911}年`;
            if (fullDate >= 18680125) return `明治${year - 1867 === 1 ? '元' : year - 1867}年`;
            return `${year}年`;
        };

        const translations = {
            ja: {
                appTitle: 'メモリープロ', calendar: 'カレンダー計算', number: 'ナンバー記憶', letter: 'レターペア', card: 'トランプ記憶',
                settings: 'アプリ設定', home: 'ホーム', penaltyText: 'ミス1問につき30秒加算', start: 'スタート', back: '戻る', result: '結果確認',
                rawTime: 'タイム', penalty: 'ペナルティ', avgTime: '平均', finalScore: 'スコア', retry: 'もう一度', changeRange: '設定変更',
                gameSettings: 'ゲーム設定', countdown: 'カウントダウン', autoNext: '自動送り', autoNextOff: 'オフ', lang: '言語',
                reset: '初期化', trainingType: '記憶術マスター', descCal: 'カレンダー曜日計算', 
                descNum: '数字変換トレーニング', descLet: 'レターペア変換トレーニング', descCard: 'トランプ記憶トレーニング',
                numConversion: '変換練習', numMemory: '記憶練習', descConversion: 'ペアをイメージに変換するのみ', descMemory: '出題されたレターを記憶する',
                next: '次へ', recall: '回答へ', recallInput: '回答入力', checkResult: '採点', correctRate: '正解率', inputPlace: '入力してください...',
                aRow: 'あ行', kaRow: 'か行', saRow: 'さ行', taRow: 'た行', naRow: 'な行', haRow: 'は行', allRows: '全選択', qCount: '出題数',
                finish: '終了', accuracy: '正解数', noData: 'データなし', alwaysShow: '初めから答えを表示', edit: '編集',
                yearMode: '表示形式', western: '西暦', era: '和暦', both: '両方', showNums: 'ボタン番号', startDay: '週の始まり',
                bunchCount: '束数', digitsPerBunch: '1束の数', digitsPerImage: '1イメージの単位', imagesPerView: '同時表示数',
                separator: '区切り', noDuplicates: '重複なし', range: '範囲',
                mon: '月', sun: '日'
            },
            en: {
                appTitle: 'MemoryPro', calendar: 'Calendar Calc', number: 'Number Memory', letter: 'Letter Pair', card: 'Card Memory',
                settings: 'Settings', home: 'Home', penaltyText: '30s penalty per mistake', start: 'Start', back: 'Back', result: 'Result',
                rawTime: 'Time', penalty: 'Penalty', avgTime: 'Avg', finalScore: 'Score', retry: 'Retry', changeRange: 'Settings',
                gameSettings: 'Game Settings', countdown: 'Countdown', autoNext: 'Auto', autoNextOff: 'Off', lang: 'Lang',
                reset: 'Reset', trainingType: 'Memory Pro', descCal: 'Calendar Calculation',
                descNum: 'Number conversion', descLet: 'Letter pair conversion', descCard: 'Card memorization',
                numConversion: 'Conversion', numMemory: 'Memory', descConversion: 'Convert to image only', descMemory: 'Memorize the letters shown',
                next: 'Next', recall: 'Recall', recallInput: 'Recall Input', checkResult: 'Check', correctRate: 'Correct Rate', inputPlace: 'Input...',
                aRow: 'A-row', kaRow: 'Ka-row', saRow: 'Sa-row', taRow: 'Ta-row', naRow: 'Na-row', haRow: 'Ha-row', allRows: 'All', qCount: 'Questions',
                finish: 'Finish', accuracy: 'Accuracy', noData: 'No Data', alwaysShow: 'Show Answer Initially', edit: 'Edit',
                yearMode: 'Year Style', western: 'Western', era: 'Era', both: 'Both', showNums: 'Index', startDay: 'Start Day',
                bunchCount: 'Bunches', digitsPerBunch: 'Digits/Bunch', digitsPerImage: 'Digits/Img', imagesPerView: 'Images/View',
                separator: 'Sep', noDuplicates: 'No Dups', range: 'Range',
                mon: 'Mon', sun: 'Sun'
            }
        };

        // --- Shared UI ---

        const GlobalSettingsModal = ({ globalSettings, setGlobalSettings, onClose, t }) => (
            <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
                <div className="bg-white w-full max-w-lg rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl p-6 overflow-y-auto max-h-[85vh] no-scrollbar">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2"><i className="fa-solid fa-sliders text-indigo-600"></i> {t.settings}</h2>
                        <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <section>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">{t.lang}</label>
                        <div className="grid grid-cols-2 gap-2">
                            {['ja', 'en'].map(l => (
                                <button key={l} onClick={() => setGlobalSettings(s => ({...s, lang: l}))} className={`py-3 rounded-xl border-2 font-bold text-sm transition-all ${globalSettings.lang === l ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-100 text-slate-400 hover:border-slate-200'}`}>
                                    {l === 'ja' ? '日本語' : 'English'}
                                </button>
                            ))}
                        </div>
                    </section>
                </div>
            </div>
        );

        // --- Calendar Trainer ---

        const CalendarSettingsModal = ({ settings, updateSettings, onClose, t }) => (
            <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-y-auto max-h-[85vh] no-scrollbar">
                    <h3 className="text-lg font-bold mb-6 text-slate-800"><i className="fa-solid fa-cog text-indigo-500"></i> {t.gameSettings}</h3>
                    <div className="space-y-5">
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.countdown}</label>
                            <div className="grid grid-cols-3 gap-2">
                                {[3, 5, 10].map(s => <button key={s} onClick={() => updateSettings('countdownSeconds', s)} className={`py-2 rounded-xl border-2 font-bold text-sm ${settings.countdownSeconds === s ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'bg-slate-50 border-slate-50 text-slate-400'}`}>{s}s</button>)}
                            </div>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.yearMode}</label>
                            <div className="grid grid-cols-3 gap-2">
                                {['western', 'japanese', 'both'].map(m => <button key={m} onClick={() => updateSettings('yearMode', m)} className={`py-2 rounded-xl border-2 font-bold text-[10px] ${settings.yearMode === m ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'bg-slate-50 border-slate-50 text-slate-400'}`}>{t[m] || m}</button>)}
                            </div>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.startDay}</label>
                            <div className="grid grid-cols-2 gap-2">
                                {[{v:0,l:t.sun}, {v:1,l:t.mon}].map(d => <button key={d.v} onClick={() => updateSettings('startDay', d.v)} className={`py-2 rounded-xl border-2 font-bold text-sm ${settings.startDay === d.v ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'bg-slate-50 border-slate-50 text-slate-400'}`}>{d.l}</button>)}
                            </div>
                        </section>
                        <section>
                            <label className="flex items-center gap-3 p-3 border-2 border-slate-100 rounded-xl cursor-pointer">
                                <input type="checkbox" checked={settings.showNumbers} onChange={(e) => updateSettings('showNumbers', e.target.checked)} className="w-5 h-5 accent-indigo-500" />
                                <span className="font-bold text-sm text-slate-700">{t.showNums}</span>
                            </label>
                        </section>
                    </div>
                    <button onClick={onClose} className="w-full mt-8 py-4 bg-slate-900 text-white font-bold rounded-2xl active:scale-95">{t.back}</button>
                </div>
            </div>
        );

        const CalendarTrainer = ({ onBack, globalSettings, t }) => {
            const [gameState, setGameState] = useState('menu');
            const [questions, setQuestions] = useState([]);
            const [activeQuestion, setActiveQuestion] = useState(0);
            const [laps, setLaps] = useState([]);
            const [startTime, setStartTime] = useState(0);
            const [currentTime, setCurrentTime] = useState(0);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const timerRef = useRef(null);

            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('calendar_settings_v4');
                return saved ? JSON.parse(saved) : { countdownSeconds: 3, yearMode: 'western', startDay: 0, showNumbers: true };
            });

            const updateSettings = (key, val) => {
                const ns = {...settings, [key]: val};
                setSettings(ns);
                localStorage.setItem('calendar_settings_v4', JSON.stringify(ns));
            };

            const startTraining = () => {
                setQuestions(Array.from({ length: 5 }, () => new Date(Math.floor(Math.random() * 200) + 1900, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1)));
                setActiveQuestion(0);
                setLaps([]);
                setGameState('playing');
                setStartTime(performance.now());
            };

            const handleAnswer = (idx) => {
                const isCorrect = questions[activeQuestion].getDay() === idx;
                const now = performance.now();
                const lap = { correct: isCorrect, duration: now - startTime - (laps.reduce((a, b) => a + b.duration, 0)) };
                setLaps(prev => [...prev, lap]);
                if (activeQuestion + 1 >= 5) setGameState('finished');
                else setActiveQuestion(prev => prev + 1);
            };

            const dayList = useMemo(() => {
                const base = ['日','月','火','水','木','金','土'].map((l, i) => ({ l, i }));
                if (settings.startDay === 1) { const mon = base.slice(1); mon.push(base[0]); return mon; }
                return base;
            }, [settings.startDay]);

            if (gameState === 'menu') return (
                <div className="h-full flex flex-col p-6 items-center justify-center">
                    <button onClick={onBack} className="absolute top-6 left-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm"><i className="fa-solid fa-house"></i></button>
                    <button onClick={() => setIsSettingsOpen(true)} className="absolute top-6 right-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-400 hover:text-indigo-600"><i className="fa-solid fa-cog"></i></button>
                    <i className="fa-solid fa-calendar-days text-6xl text-indigo-500 mb-6"></i>
                    <h2 className="text-2xl font-black mb-10 text-slate-800">{t.calendar}</h2>
                    <button onClick={startTraining} className="w-full max-w-sm py-6 bg-indigo-600 text-white text-xl font-black rounded-[2rem] shadow-lg active:scale-95">{t.start}</button>
                    {isSettingsOpen && <CalendarSettingsModal settings={settings} updateSettings={updateSettings} onClose={() => setIsSettingsOpen(false)} t={t} />}
                </div>
            );

            if (gameState === 'playing') {
                const q = questions[activeQuestion];
                return (
                    <div className="h-full flex flex-col p-6">
                        <div className="flex justify-between items-center mb-10">
                            <span className="font-black text-indigo-600 uppercase tracking-widest">{activeQuestion + 1} / 5</span>
                            <button onClick={() => setGameState('menu')} className="px-4 py-2 bg-white text-slate-500 rounded-full font-bold text-xs shadow-sm">{t.finish}</button>
                        </div>
                        <div className="flex-grow flex flex-col items-center justify-center">
                            <div className="text-4xl font-black text-slate-800 mb-2">
                                {settings.yearMode === 'japanese' ? getJapaneseEra(q) : `${q.getFullYear()}年`}
                                {settings.yearMode === 'both' && <span className="text-lg text-slate-400 ml-2">({getJapaneseEra(q)})</span>}
                                {` ${q.getMonth()+1}月${q.getDate()}日`}
                            </div>
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {dayList.map(({ l, i }) => (
                                <button key={i} onClick={() => handleAnswer(i)} className={`aspect-[3/4] rounded-xl border-2 flex flex-col items-center justify-center transition-all active:scale-90 ${i === 0 ? 'text-red-500 border-red-50' : i === 6 ? 'text-blue-500 border-blue-50' : 'text-slate-700 border-slate-50 bg-white shadow-sm'}`}>
                                    <span className="font-bold text-lg">{l}</span>
                                    {settings.showNumbers && <span className="text-[10px] opacity-30 font-black">{i}</span>}
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (gameState === 'finished') {
                const total = laps.reduce((a,b)=>a+b.duration,0);
                const pen = laps.filter(l=>!l.correct).length * 30000;
                return (
                    <div className="h-full flex flex-col p-6 items-center justify-center">
                        <h2 className="text-3xl font-black mb-10 text-slate-800">{t.result}</h2>
                        <div className="bg-indigo-600 text-white rounded-[2rem] p-8 w-full max-w-sm mb-10 text-center">
                            <div className="text-xs font-bold opacity-60 uppercase tracking-widest mb-1">{t.finalScore}</div>
                            <div className="text-5xl font-mono font-black">{formatTime(total + pen)}</div>
                        </div>
                        <button onClick={() => setGameState('menu')} className="w-full max-w-sm py-6 bg-slate-200 text-slate-600 text-xl font-black rounded-[2rem] active:scale-95">{t.back}</button>
                    </div>
                );
            }
        };

        // --- Number Trainer ---

        const NumberSettingsModal = ({ settings, updateSettings, onClose, t }) => (
            <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-y-auto max-h-[85vh] no-scrollbar">
                    <h3 className="text-lg font-bold mb-6 text-slate-800"><i className="fa-solid fa-cog text-emerald-500"></i> {t.gameSettings}</h3>
                    <div className="space-y-4">
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 block">{t.range}</label>
                            <div className="flex gap-2">
                                <input type="number" value={settings.rangeStart} onChange={e=>updateSettings('rangeStart', parseInt(e.target.value))} className="w-full p-2 border-2 rounded-xl font-bold text-center" placeholder="0" />
                                <input type="number" value={settings.rangeEnd} onChange={e=>updateSettings('rangeEnd', parseInt(e.target.value))} className="w-full p-2 border-2 rounded-xl font-bold text-center" placeholder="99" />
                            </div>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 block">{t.digitsPerImage}</label>
                            <select value={settings.digitsPerImage} onChange={e=>updateSettings('digitsPerImage', parseInt(e.target.value))} className="w-full p-2.5 border-2 rounded-xl font-bold bg-white">
                                {[1, 2, 3].map(n => <option key={n} value={n}>{n}</option>)}
                            </select>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 block">{t.qCount}</label>
                            <select value={settings.qCount} onChange={e=>updateSettings('qCount', parseInt(e.target.value))} className="w-full p-2.5 border-2 rounded-xl font-bold bg-white">
                                {[10, 20, 30, 40, 50, 100].map(n => <option key={n} value={n}>{n}</option>)}
                            </select>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 block">{t.autoNext}</label>
                            <select value={settings.autoNext} onChange={e=>updateSettings('autoNext', parseFloat(e.target.value))} className="w-full p-2.5 border-2 rounded-xl font-bold bg-white">
                                <option value={0}>{t.autoNextOff}</option>
                                {[0.5, 1.0, 1.5, 2.0, 3.0, 5.0].map(n => <option key={n} value={n}>{n}s</option>)}
                            </select>
                        </section>
                    </div>
                    <button onClick={onClose} className="w-full mt-8 py-4 bg-slate-900 text-white font-bold rounded-2xl active:scale-95">{t.back}</button>
                </div>
            </div>
        );

        const NumberTrainer = ({ onBack, globalSettings, t }) => {
            const [gameState, setGameState] = useState('menu');
            const [trainingType, setTrainingType] = useState(null);
            const [sequence, setSequence] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userInput, setUserInput] = useState("");
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [startTime, setStartTime] = useState(0);
            const [endTime, setEndTime] = useState(0);

            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('number_settings_v4');
                return saved ? JSON.parse(saved) : { rangeStart: 0, rangeEnd: 99, digitsPerImage: 2, qCount: 20, autoNext: 0 };
            });

            const updateSettings = (key, val) => {
                const ns = {...settings, [key]: val};
                setSettings(ns);
                localStorage.setItem('number_settings_v4', JSON.stringify(ns));
            };

            const startTraining = (type) => {
                setTrainingType(type);
                const seq = Array.from({ length: settings.qCount }, () => {
                    const num = Math.floor(Math.random() * (settings.rangeEnd - settings.rangeStart + 1)) + settings.rangeStart;
                    return num.toString().padStart(settings.digitsPerImage, '0');
                });
                setSequence(seq);
                setCurrentIndex(0);
                setUserInput("");
                setGameState('playing');
                setStartTime(performance.now());
            };

            useEffect(() => {
                let t;
                if (gameState === 'playing' && settings.autoNext > 0) {
                    t = setInterval(() => {
                        if (currentIndex + 1 >= sequence.length) {
                            clearInterval(t);
                            if (trainingType === 'memory') setGameState('recall');
                            else setGameState('menu');
                        } else setCurrentIndex(prev => prev + 1);
                    }, settings.autoNext * 1000);
                }
                return () => clearInterval(t);
            }, [gameState, currentIndex, settings.autoNext]);

            if (gameState === 'menu') return (
                <div className="h-full flex flex-col p-6 items-center justify-center gap-6">
                    <button onClick={onBack} className="absolute top-6 left-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm"><i className="fa-solid fa-house"></i></button>
                    <button onClick={() => setIsSettingsOpen(true)} className="absolute top-6 right-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-400 hover:text-emerald-600"><i className="fa-solid fa-cog"></i></button>
                    <button onClick={() => startTraining('conversion')} className="w-full max-w-sm p-6 bg-white border-2 border-slate-100 rounded-[2rem] shadow-sm active:scale-95 text-left group hover:border-emerald-200 transition-all">
                        <div className="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-500 mb-4 text-2xl group-hover:bg-emerald-500 group-hover:text-white transition-colors"><i className="fa-solid fa-shuffle"></i></div>
                        <div className="text-xl font-black text-slate-800 mb-1">{t.numConversion}</div>
                        <div className="text-xs font-bold text-slate-400">{t.descConversion}</div>
                    </button>
                    <button onClick={() => startTraining('memory')} className="w-full max-w-sm p-6 bg-emerald-600 text-white rounded-[2rem] shadow-lg active:scale-95 text-left transition-all">
                        <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-white mb-4 text-2xl"><i className="fa-solid fa-brain"></i></div>
                        <div className="text-xl font-black mb-1">{t.numMemory}</div>
                        <div className="text-xs font-bold text-emerald-100">{t.descMemory}</div>
                    </button>
                    {isSettingsOpen && <NumberSettingsModal settings={settings} updateSettings={updateSettings} onClose={() => setIsSettingsOpen(false)} t={t} />}
                </div>
            );

            if (gameState === 'playing') return (
                <div className="h-full flex flex-col p-6">
                    <div className="flex justify-between items-center mb-10">
                        <span className="font-black text-emerald-600 uppercase tracking-widest">{currentIndex + 1} / {sequence.length}</span>
                        <button onClick={() => setGameState('menu')} className="px-4 py-2 bg-white text-slate-500 rounded-full font-bold text-xs shadow-sm">{t.finish}</button>
                    </div>
                    <div className="flex-grow flex items-center justify-center">
                        <div className="text-8xl font-mono font-black text-slate-800">{sequence[currentIndex]}</div>
                    </div>
                    <button onClick={() => currentIndex + 1 >= sequence.length ? (trainingType === 'memory' ? setGameState('recall') : setGameState('menu')) : setCurrentIndex(prev => prev + 1)} className="w-full py-8 bg-emerald-600 text-white text-2xl font-black rounded-[2rem] active:scale-95">
                        {currentIndex + 1 >= sequence.length ? (trainingType === 'memory' ? t.recall : t.finish) : t.next}
                    </button>
                </div>
            );

            if (gameState === 'recall') return (
                <div className="h-full flex flex-col p-6">
                    <div className="flex justify-between items-center mb-4">
                        <span className="font-black text-emerald-600">RECALL</span>
                        <button onClick={() => setGameState('menu')} className="px-4 py-2 bg-slate-100 text-slate-500 rounded-full font-bold text-xs">{t.finish}</button>
                    </div>
                    <div className="flex-grow">
                        <div className="w-full h-32 bg-white rounded-2xl border-2 border-slate-200 p-4 font-mono text-2xl font-bold tracking-widest break-all overflow-y-auto mb-6 shadow-inner">
                            {userInput || <span className="text-slate-300">{t.inputPlace}</span>}
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            {[1,2,3,4,5,6,7,8,9,0].map(n => <button key={n} onClick={() => setUserInput(prev => prev + n)} className="py-6 bg-white rounded-2xl border-b-4 border-slate-100 text-2xl font-black text-slate-700 active:border-b-0 active:translate-y-1">{n}</button>)}
                            <button onClick={() => setUserInput(prev => prev.slice(0, -1))} className="py-6 bg-red-50 text-red-500 rounded-2xl border-b-4 border-red-100 text-2xl font-black active:border-b-0 active:translate-y-1"><i className="fa-solid fa-delete-left"></i></button>
                            <button onClick={() => { setEndTime(performance.now()); setGameState('finished'); }} className="py-6 bg-emerald-600 text-white rounded-2xl border-b-4 border-emerald-800 text-xl font-black active:border-b-0 active:translate-y-1">{t.checkResult}</button>
                        </div>
                    </div>
                </div>
            );

            if (gameState === 'finished') {
                const fullSeq = sequence.join('');
                let correct = 0;
                for (let i = 0; i < Math.min(fullSeq.length, userInput.length); i++) if (fullSeq[i] === userInput[i]) correct++;
                return (
                    <div className="h-full flex flex-col p-6 items-center justify-center">
                        <h2 className="text-3xl font-black mb-10 text-slate-800">{t.result}</h2>
                        <div className="bg-emerald-600 text-white rounded-[2rem] p-8 w-full max-w-sm mb-6 text-center shadow-xl">
                            <div className="text-xs font-bold opacity-60 uppercase mb-2">CORRECT RATE</div>
                            <div className="text-4xl font-mono font-black">{correct} / {fullSeq.length}</div>
                        </div>
                        <div className="bg-white rounded-2xl p-4 w-full max-w-sm mb-10 overflow-y-auto max-h-40 font-mono text-sm break-all leading-relaxed shadow-sm">
                            {fullSeq.split('').map((c, i) => <span key={i} className={userInput[i] === c ? 'text-emerald-600 font-bold' : userInput[i] ? 'text-red-500 font-bold bg-red-50' : 'text-slate-300'}>{c}</span>)}
                        </div>
                        <button onClick={() => setGameState('menu')} className="w-full max-w-sm py-6 bg-slate-200 text-slate-600 text-xl font-black rounded-[2rem] active:scale-95">{t.back}</button>
                    </div>
                );
            }
        };

        // --- Card Trainer ---

        const CardTrainer = ({ onBack, globalSettings, t }) => {
            const [gameState, setGameState] = useState('menu');
            const [deck, setDeck] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);

            const startTraining = () => {
                const fullDeck = [];
                SUITS.forEach(s => VALUES.forEach(v => fullDeck.push({ suit: s, value: v, id: generateId() })));
                for (let i = fullDeck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [fullDeck[i], fullDeck[j]] = [fullDeck[j], fullDeck[i]];
                }
                setDeck(fullDeck);
                setCurrentIndex(0);
                setGameState('playing');
            };

            if (gameState === 'menu') return (
                <div className="h-full flex flex-col p-6 items-center justify-center">
                    <button onClick={onBack} className="absolute top-6 left-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm"><i className="fa-solid fa-house"></i></button>
                    <i className="fa-solid fa-diamond text-6xl text-rose-500 mb-6"></i>
                    <h2 className="text-2xl font-black mb-10 text-slate-800">{t.card}</h2>
                    <button onClick={startTraining} className="w-full max-w-sm py-6 bg-rose-500 text-white text-xl font-black rounded-[2rem] shadow-lg active:scale-95">{t.start}</button>
                </div>
            );

            if (gameState === 'playing') {
                const card = deck[currentIndex];
                const isRed = card.suit === 'heart' || card.suit === 'diamond';
                return (
                    <div className="h-full flex flex-col p-6">
                        <div className="flex justify-between items-center mb-6">
                            <span className="font-black text-rose-600 uppercase tracking-widest">{currentIndex + 1} / 52</span>
                            <button onClick={() => setGameState('menu')} className="px-4 py-2 bg-white text-slate-500 rounded-full font-bold text-xs shadow-sm">{t.finish}</button>
                        </div>
                        <div className="flex-grow flex flex-col items-center justify-center">
                            <div className={`w-48 h-72 bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col items-center justify-center relative ${isRed ? 'text-red-500' : 'text-slate-800'}`}>
                                <div className="absolute top-4 left-4 text-2xl font-black leading-none">{card.value}<br/>{SUIT_ICONS[card.suit]}</div>
                                <div className="text-9xl">{SUIT_ICONS[card.suit]}</div>
                                <div className="absolute bottom-4 right-4 text-2xl font-black leading-none rotate-180">{card.value}<br/>{SUIT_ICONS[card.suit]}</div>
                            </div>
                        </div>
                        <button onClick={() => currentIndex + 1 >= 52 ? setGameState('menu') : setCurrentIndex(prev => prev + 1)} className="w-full py-6 mt-6 bg-rose-500 text-white text-xl font-black rounded-[2rem] active:scale-95">
                            {currentIndex + 1 >= 52 ? t.finish : t.next}
                        </button>
                    </div>
                );
            }
        };

        // --- Letter Pair Trainer ---

        const LetterPairSettingsModal = ({ settings, updateSettings, onClose, t }) => {
            const rowKeys = ['あ', 'か', 'さ', 'た', 'な', 'は'];
            return (
                <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-y-auto max-h-[85vh] no-scrollbar">
                        <h3 className="text-lg font-bold mb-6 text-slate-800"><i className="fa-solid fa-cog text-amber-500"></i> {t.gameSettings}</h3>
                        <div className="space-y-5">
                            <section>
                                <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.range}</label>
                                <div className="grid grid-cols-3 gap-2">
                                    {rowKeys.map(r => (
                                        <button key={r} onClick={() => updateSettings('activeRows', settings.activeRows.includes(r) ? settings.activeRows.filter(x => x!==r) : [...settings.activeRows, r])} className={`py-2 rounded-xl border-2 font-bold text-sm transition-all ${settings.activeRows.includes(r) ? 'bg-amber-50 border-amber-600 text-amber-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>{r}行</button>
                                    ))}
                                </div>
                            </section>
                            <section>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 block">{t.qCount}</label>
                                <select value={settings.qCount} onChange={e=>updateSettings('qCount', parseInt(e.target.value))} className="w-full p-2.5 border-2 rounded-xl font-bold bg-white">
                                    {[10, 20, 30, 40, 50, 80, 100].map(n => <option key={n} value={n}>{n}</option>)}
                                </select>
                            </section>
                            <section>
                                <label className="flex items-center gap-3 p-3 border-2 border-slate-100 rounded-xl cursor-pointer">
                                    <input type="checkbox" checked={settings.alwaysShowAnswer} onChange={(e) => updateSettings('alwaysShowAnswer', e.target.checked)} className="w-5 h-5 accent-amber-500" />
                                    <span className="font-bold text-sm text-slate-700">{t.alwaysShow}</span>
                                </label>
                            </section>
                            <section>
                                <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.autoNext}</label>
                                <select value={settings.autoNext} onChange={(e) => updateSettings('autoNext', parseFloat(e.target.value))} className="w-full p-2.5 border-2 rounded-xl font-bold bg-white">
                                    <option value={0}>{t.autoNextOff}</option>
                                    {[0.5, 1.0, 1.5, 2.0, 3.0, 5.0].map(n => <option key={n} value={n}>{n}s</option>)}
                                </select>
                            </section>
                        </div>
                        <button onClick={onClose} className="w-full mt-8 py-4 bg-slate-900 text-white font-bold rounded-2xl active:scale-95">{t.back}</button>
                    </div>
                </div>
            );
        };

        const LetterPairTrainer = ({ onBack, globalSettings, t }) => {
            const [gameState, setGameState] = useState('menu');
            const [trainingType, setTrainingType] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            const [input, setInput] = useState("");
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isAnswerShown, setIsAnswerShown] = useState(false);
            const [startTime, setStartTime] = useState(0);
            const [endTime, setEndTime] = useState(0);

            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('letter_settings_v4');
                return saved ? JSON.parse(saved) : { activeRows: ['あ'], qCount: 10, autoNext: 0, countdownSeconds: 3, alwaysShowAnswer: false };
            });

            const [masterData, setMasterData] = useState(() => {
                const saved = localStorage.getItem('letter_master_custom_v4');
                return saved ? JSON.parse(saved) : DEFAULT_LETTER_MASTER;
            });

            const updateSettings = (key, val) => {
                const ns = {...settings, [key]: val};
                setSettings(ns);
                localStorage.setItem('letter_settings_v4', JSON.stringify(ns));
            };

            const saveMasterData = (newMaster) => {
                setMasterData(newMaster);
                localStorage.setItem('letter_master_custom_v4', JSON.stringify(newMaster));
            };

            const generateQuestions = useCallback(() => {
                const pool = [];
                settings.activeRows.forEach(row => {
                    const data = masterData[row];
                    if (data) Object.keys(data).forEach(pair => pool.push({ pair, answer: data[pair], row }));
                });
                if (pool.length === 0) return [];
                const res = [];
                for(let i=0; i < settings.qCount; i++) res.push(pool[Math.floor(Math.random() * pool.length)]);
                return res;
            }, [settings, masterData]);

            const startTraining = (type) => {
                const qs = generateQuestions();
                if (qs.length === 0) return;
                setTrainingType(type);
                setQuestions(qs);
                setCurrentIndex(0);
                setUserAnswers([]);
                setIsAnswerShown(type === 'conversion' ? settings.alwaysShowAnswer : false);
                setGameState('training');
                setStartTime(performance.now());
            };

            useEffect(() => {
                let timer;
                if(gameState === 'training' && settings.autoNext > 0 && trainingType === 'conversion') {
                    timer = setInterval(() => handleNext(), settings.autoNext * 1000);
                }
                return () => clearInterval(timer);
            }, [gameState, currentIndex, settings.autoNext, trainingType]);

            const handleNext = () => {
                if (currentIndex + 1 >= questions.length) {
                    if (trainingType === 'memory') setGameState('recall');
                    else setGameState('menu');
                } else {
                    setCurrentIndex(prev => prev + 1);
                    setIsAnswerShown(trainingType === 'conversion' ? settings.alwaysShowAnswer : false);
                }
            };

            const handleEditMaster = () => {
                const q = questions[currentIndex];
                const newAnswer = window.prompt(`${q.pair} の新しいイメージを入力してください`, q.answer);
                if (newAnswer !== null && newAnswer.trim() !== "") {
                    const updatedMaster = {...masterData};
                    updatedMaster[q.row][q.pair] = newAnswer.trim();
                    saveMasterData(updatedMaster);
                    const updatedQuestions = [...questions];
                    updatedQuestions[currentIndex].answer = newAnswer.trim();
                    setQuestions(updatedQuestions);
                }
            };

            if (gameState === 'menu') return (
                <div className="h-full flex flex-col p-6 items-center justify-center gap-6">
                    <button onClick={onBack} className="absolute top-6 left-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm"><i className="fa-solid fa-house"></i></button>
                    <button onClick={() => setIsSettingsOpen(true)} className="absolute top-6 right-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-400 hover:text-amber-500"><i className="fa-solid fa-cog"></i></button>
                    <button onClick={() => startTraining('conversion')} className="w-full max-w-sm p-6 bg-white border-2 border-slate-100 rounded-[2rem] shadow-sm active:scale-95 text-left group hover:border-amber-200 transition-all">
                        <div className="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center text-amber-500 mb-4 text-2xl group-hover:bg-amber-500 group-hover:text-white transition-colors"><i className="fa-solid fa-shuffle"></i></div>
                        <div className="text-xl font-black text-slate-800 mb-1">{t.numConversion}</div>
                        <div className="text-xs font-bold text-slate-400">{t.descConversion}</div>
                    </button>
                    <button onClick={() => startTraining('memory')} className="w-full max-w-sm p-6 bg-amber-600 text-white rounded-[2rem] shadow-lg active:scale-95 text-left transition-all">
                        <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-white mb-4 text-2xl"><i className="fa-solid fa-brain"></i></div>
                        <div className="text-xl font-black mb-1">{t.numMemory}</div>
                        <div className="text-xs font-bold text-amber-100">{t.descMemory}</div>
                    </button>
                    {isSettingsOpen && <LetterPairSettingsModal settings={settings} updateSettings={updateSettings} onClose={() => setIsSettingsOpen(false)} t={t} />}
                </div>
            );

            if (gameState === 'training') {
                const q = questions[currentIndex];
                return (
                    <div className="h-full flex flex-col p-6 bg-amber-50">
                        <div className="flex justify-between items-center mb-6">
                            <span className="font-black text-amber-600 uppercase tracking-widest">{currentIndex + 1} / {questions.length}</span>
                            <button onClick={() => setGameState('menu')} className="px-4 py-2 bg-white text-slate-500 rounded-full font-bold text-xs shadow-sm">{t.finish}</button>
                        </div>
                        <div className="flex-grow flex flex-col items-center justify-center">
                            <div className="text-8xl font-black text-amber-800 mb-8">{q.pair}</div>
                            {trainingType === 'conversion' && (
                                <div className="h-24 flex items-center justify-center gap-4">
                                    {isAnswerShown ? (
                                        <>
                                            <div className="text-4xl font-black text-slate-500">{q.answer}</div>
                                            <button onClick={handleEditMaster} className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-slate-300 hover:text-amber-500 shadow-sm transition-colors"><i className="fa-solid fa-pen text-xs"></i></button>
                                        </>
                                    ) : (
                                        <button onClick={() => setIsAnswerShown(true)} className="px-6 py-3 bg-white/50 text-slate-400 font-bold rounded-xl border border-slate-200">答えを表示</button>
                                    )}
                                </div>
                            )}
                        </div>
                        <button onClick={handleNext} className="w-full py-8 bg-white text-amber-600 text-2xl font-black rounded-[2rem] shadow-xl active:scale-95 transition-all">
                            {currentIndex + 1 >= questions.length ? (trainingType === 'memory' ? t.recall : t.finish) : t.next}
                        </button>
                    </div>
                );
            }

            if (gameState === 'recall') {
                const q = questions[currentIndex];
                return (
                    <div className="h-full flex flex-col p-4 bg-slate-50">
                        <div className="flex justify-between items-center mb-4">
                            <span className="font-black text-amber-600 uppercase tracking-widest">{currentIndex + 1} / {questions.length}</span>
                            <button onClick={() => setGameState('menu')} className="px-4 py-2 bg-slate-200 text-slate-500 rounded-full font-bold text-xs shadow-sm">{t.finish}</button>
                        </div>
                        <div className="flex-grow flex flex-col items-center justify-center">
                            <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">RECORDED PAIR #{currentIndex+1}</div>
                            <input 
                                type="text" value={input} autoFocus onChange={e => setInput(e.target.value)} 
                                onKeyDown={e => e.key === 'Enter' && (()=>{
                                    const up = [...userAnswers]; up[currentIndex] = input; setUserAnswers(up); setInput("");
                                    if(currentIndex + 1 >= questions.length) { setEndTime(performance.now()); setGameState('result'); } else setCurrentIndex(prev => prev + 1);
                                })()}
                                className="w-full max-w-sm p-5 text-center text-4xl font-black border-4 border-amber-200 rounded-3xl outline-none focus:border-amber-500 bg-white" placeholder="？" 
                            />
                        </div>
                        <button onClick={()=>{
                            const up = [...userAnswers]; up[currentIndex] = input; setUserAnswers(up); setInput("");
                            if(currentIndex + 1 >= questions.length) { setEndTime(performance.now()); setGameState('result'); } else setCurrentIndex(prev => prev + 1);
                        }} className="w-full py-6 bg-amber-600 text-white text-xl font-black rounded-[2rem] active:scale-95 transition-all mt-8">{t.next}</button>
                    </div>
                );
            }

            if (gameState === 'result') {
                const correctCount = userAnswers.filter((ans, i) => ans === questions[i].pair).length;
                return (
                    <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                        <h2 className="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2"><i className="fa-solid fa-square-check text-amber-500"></i> {t.result}</h2>
                        <div className="bg-amber-50 rounded-[2rem] p-8 w-full mb-6 flex justify-between items-center border border-amber-100 shadow-sm">
                            <div><div className="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-1">{t.accuracy}</div><div className="text-4xl font-black text-slate-800">{correctCount} <span className="text-lg text-slate-400">/ {questions.length}</span></div></div>
                            <div><div className="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-1">{t.rawTime}</div><div className="text-4xl font-black text-slate-800">{formatTime(endTime - startTime)}</div></div>
                        </div>
                        <div className="space-y-2 mb-10">
                            {questions.map((q, i) => {
                                const isCorrect = userAnswers[i] === q.pair;
                                return (
                                    <div key={i} className={`p-4 rounded-xl border flex justify-between items-center ${isCorrect ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                                        <div>
                                            <div className="font-black text-lg text-slate-700">{q.pair}</div>
                                            <div className={`text-sm font-bold ${isCorrect ? 'text-green-600' : 'text-red-500'}`}>{isCorrect ? 'Correct' : `Ans: ${userAnswers[i] || '-'} (True: ${q.pair})`}</div>
                                        </div>
                                        {isCorrect ? <i className="fa-solid fa-check text-green-500"></i> : <i className="fa-solid fa-xmark text-red-500"></i>}
                                    </div>
                                );
                            })}
                        </div>
                        <button onClick={() => setGameState('menu')} className="w-full py-6 bg-slate-900 text-white font-black rounded-[2rem] shadow-lg mb-10 active:scale-95">{t.back}</button>
                    </div>
                );
            }
        };

        const HomeView = ({ onSelectMode, onOpenSettings, t }) => {
            const modes = [
                { id: 'calendar', label: t.calendar, icon: 'fa-calendar-days', color: 'bg-indigo-500', desc: t.descCal },
                { id: 'number', label: t.number, icon: 'fa-hashtag', color: 'bg-emerald-500', desc: t.descNum },
                { id: 'card', label: t.card, icon: 'fa-diamond', color: 'bg-rose-500', desc: t.descCard },
                { id: 'letterpair', label: t.letter, icon: 'fa-language', color: 'bg-amber-500', desc: t.descLet }
            ];
            return (
                <div className="h-full flex flex-col p-6 overflow-y-auto no-scrollbar">
                    <div className="flex items-center justify-between mb-12 pt-2">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><i className="fa-solid fa-brain text-xl"></i></div>
                            <div>
                                <h1 className="text-xl font-black tracking-tight text-slate-800">{t.appTitle}</h1>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-tight">{t.trainingType}</p>
                            </div>
                        </div>
                        <button onClick={onOpenSettings} className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-slate-400 hover:text-indigo-600 shadow-sm border border-slate-100"><i className="fa-solid fa-gear"></i></button>
                    </div>
                    <div className="space-y-5">
                        {modes.map(m => (
                            <button key={m.id} onClick={() => onSelectMode(m.id)} className="w-full bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm active:scale-95 transition-all flex items-center text-left hover:shadow-md">
                                <div className={`w-14 h-14 ${m.color} rounded-2xl flex items-center justify-center text-white shadow-md mr-5`}><i className={`fa-solid ${m.icon} text-xl`}></i></div>
                                <div className="flex-grow">
                                    <div className="font-black text-lg mb-0.5 text-slate-800">{m.label}</div>
                                    <div className="text-xs text-slate-400 font-bold tracking-tight">{m.desc}</div>
                                </div>
                                <i className="fa-solid fa-chevron-right text-slate-300 ml-2"></i>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('home');
            const [isGlobalSettingsOpen, setIsGlobalSettingsOpen] = useState(false);
            const [globalSettings, setGlobalSettings] = useState(() => {
                const saved = localStorage.getItem('global_settings');
                return saved ? JSON.parse(saved) : { lang: 'ja', theme: 'light' };
            });
            useEffect(() => { localStorage.setItem('global_settings', JSON.stringify(globalSettings)); }, [globalSettings]);
            const t = translations[globalSettings.lang] || translations.ja;

            return (
                <main className="w-full h-full flex flex-col relative overflow-hidden bg-slate-50">
                    {mode === 'home' && <HomeView t={t} onSelectMode={setMode} onOpenSettings={() => setIsGlobalSettingsOpen(true)} />}
                    {mode === 'calendar' && <CalendarTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                    {mode === 'number' && <NumberTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                    {mode === 'card' && <CardTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                    {mode === 'letterpair' && <LetterPairTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                    {isGlobalSettingsOpen && <GlobalSettingsModal globalSettings={globalSettings} setGlobalSettings={setGlobalSettings} onClose={() => setIsGlobalSettingsOpen(false)} t={t} />}
                </main>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>