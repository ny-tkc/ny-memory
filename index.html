<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>メモリープロ - 記憶術マスター</title>
    
    <!-- CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & Libraries (UMD Globals) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Generated App Icons -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%234f46e5'/%3E%3Cpath d='M256 112c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144zm0 240c-53 0-96-43-96-96s43-96 96-96 96 43 96 96-43 96-96 96z' fill='white' opacity='0.2'/%3E%3Cpath d='M352 256c0 53-43 96-96 96s-96-43-96-96 43-96 96-96 96 43 96 96zm-48 0c0-26.5-21.5-48-48-48s-48 21.5-48 48 21.5 48 48 48-48-21.5 48-48z' fill='white'/%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%234f46e5'/%3E%3Cpath d='M256 112c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144zm0 240c-53 0-96-43-96-96s43-96 96-96 96 43 96 96-43 96-96 96z' fill='white' opacity='0.2'/%3E%3Cpath d='M352 256c0 53-43 96-96 96s-96-43-96-96 43-96 96-96 96 43 96 96zm-48 0c0-26.5-21.5-48-48-48s-48 21.5-48 48 21.5 48 48 48-48-21.5 48-48z' fill='white'/%3E%3C/svg%3E">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap');

        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overscroll-behavior-y: contain;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #root { height: 100%; width: 100%; }

        button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes countdown-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-countdown { animation: countdown-pulse 1s ease-in-out infinite; }

        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop-in 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
    // Extract React hooks from global React object (UMD)
    const { useState, useEffect, useCallback, useRef, useMemo } = React;
    
    // --- Data Definitions ---
    const DEFAULT_LETTER_MASTER = {
        'あ': { 'いう': 'EU', 'いえ': '家', 'いか': 'イカ', 'いき': '息', 'いく': 'イクラ', 'いけ': 'イケメン', 'いさ': '居酒屋', 'いし': '石', 'いす': '椅子', 'うい': 'ウインナー', 'うえ': 'ウエハース', 'うか': '羽化', 'うき': '浮き輪', 'うく': 'ウクライナ', 'うけ': '受付', 'うさ': 'うさぎ', 'うし': '牛', 'うす': '臼', 'えい': 'エイ', 'えう': 'AU', 'えか': 'エガちゃん', 'えき': '駅', 'えく': 'えくぼ', 'えけ': 'AKB', 'えさ': '餌', 'えし': '壊死', 'えす': 'エスカレーター' },
        'か': { 'かい': '貝', 'かう': 'カウボーイ', 'かえ': 'カエル', 'かき': '牡蠣', 'かく': '核', 'かけ': '影', 'かさ': '傘', 'かし': '火事', 'かす': '春日', 'きい': '黄色', 'きう': 'キウイ', 'きえ': '松本きえ', 'きか': '機械', 'きく': 'きくらげ', 'きけ': '危険', 'きさ': '喫茶店', 'きし': '騎士', 'きす': '傷', 'くい': 'クイナ', 'くう': 'Qoo', 'くえ': 'クエ', 'くか': '空海', 'くき': 'クッキー', 'くけ': '公家', 'くさ': '草', 'くし': '櫛', 'くす': 'くす玉', 'けい': 'ゲイ', 'けう': '今日', 'けえ': 'ゲーム', 'けか': '外科医', 'けき': '劇', 'けく': 'ケイク', 'けさ': '袈裟固め', 'けし': '化粧', 'けす': 'ゲス極' },
        'さ': { 'さい': 'サイ', 'さう': 'サウナ', 'さえ': '紗恵', 'さか': 'サッカー', 'さき': '詐欺', 'さく': '桜', 'さけ': '酒', 'さし': 'サッシー', 'さす': 'サスケ', 'しい': '椎名林檎', 'しう': 'しゅうまい', 'しえ': 'シェー', 'しか': 'シカ', 'しき': '指揮', 'しく': 'しくしく', 'しけ': '死刑', 'しさ': 'シーサー', 'しす': 'シス研', 'すい': 'スイカ', 'すう': '数学', 'すえ': '末広課長', 'すか': 'スカイツリー', 'すき': 'スキー', 'すく': 'スク水', 'すけ': 'スケート', 'すさ': 'スザンヌ', 'すし': '寿司', 'せい': '精子', 'せう': 'ゼウス', 'せえ': 'セールス', 'せか': 'セカオワ', 'せき': '咳', 'せく': 'セクハラ', 'せけ': '石鹸', 'せさ': 'セサミストリート', 'せし': 'セシウム', 'せす': 'セスナ' },
        'た': { 'たい': '鯛', 'たう': '田植え', 'たえ': '耐える', 'たか': '鷹', 'たき': '滝', 'たく': 'タクシー', 'たけ': 'タケノコ', 'たさ': 'ターザン', 'たし': '出汁', 'たす': 'TAS', 'ちい': 'ちいかわ', 'ちう': 'チューリップ', 'ちえ': '知恵袋', 'ちか': '痴漢', 'ちき': 'チキン', 'ちく': '乳首', 'ちけ': 'チケット', 'ちし': '知事', 'ちす': 'チーズ', 'てい': '手越', 'てう': '手打ちうどん', 'てえ': 'テープ', 'てか': '手鏡', 'てき': 'テキーラ', 'てく': '手首', 'てけ': 'テケテケ', 'てさ': 'テーザー銃', 'てし': '手品', 'てす': 'テスト' },
        'な': { 'にい': '新居', 'にう': 'NEW', 'にえ': '三重', 'にか': 'ニカ', 'にき': 'ニキビ', 'にく': '肉', 'にけ': 'ニケ', 'にさ': 'NISA', 'にし': 'にっしー', 'にす': 'ニス', 'ぬい': 'ぬいぐるみ', 'ぬう': 'King Gnu', 'ぬえ': 'ぬえ', 'ぬか': 'ぬか漬け', 'ぬき': '抜き', 'ぬく': '温水', 'ぬけ': '抜け毛', 'ぬさ': 'ムササビ', 'ぬし': '主', 'ぬす': '盗人', 'ねい': 'ネイマール', 'ねう': '値打ち', 'ねえ': '姉さん', 'ねか': 'ネカフェ', 'ねき': 'ネギ', 'ねく': 'ネクタイ', 'ねけ': '練り消し', 'ねさ': 'ネザー', 'ねし': 'ネッシー', 'ねす': 'ネス' },
        'は': { 'はい': '肺', 'はう': 'はうはる', 'はえ': 'ハエ', 'はか': '墓', 'はき': '覇気', 'はく': '吐く', 'はけ': 'ハゲ', 'はさ': 'ハサミ', 'はし': '橋', 'はす': '蓮見クレア', 'ひい': 'ひいおばあちゃん', 'ひう': '火打ち石', 'ひえ': 'ピエロ', 'ひか': 'ヒカキン', 'ひき': 'ひきこもり', 'ひく': 'ピクミン', 'ひけ': 'ひげ', 'ひさ': 'ピザ', 'ひし': '秘書', 'ひす': '翡翠', 'ふい': '南くん', 'ふう': '風船', 'ふえ': '笛', 'ふか': '深キョン', 'ふき': '吹き矢', 'ふく': 'フグ', 'ふけ': 'ふけ', 'ふさ': 'ブサイク', 'ふし': '富士山', 'ふす': '襖', 'へい': 'ヘイホー', 'へう': 'ヘリウム', 'へえ': 'ベーコン', 'へか': 'PEKKA', 'へき': 'ベッキー', 'へく': 'ベクター', 'へけ': 'ぺけたん', 'へさ': '偏差値', 'へし': 'ヘッショ', 'へす': 'ベス' }
    };

    const DAYS_JP = ['日', '月', '火', '水', '木', '金', '土'];
    const DAYS_JP_LONG = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];
    const DAYS_EN = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const DAYS_EN_LONG = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    const SUITS = ['spade', 'heart', 'diamond', 'club'];
    const SUIT_ICONS = { spade: '♠', heart: '♥', diamond: '♦', club: '♣' };
    const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    
    // Letter Pair Constants
    const KANA_ROWS = ['あ','か','さ','た','な','は','ま','や','ら','わ'];
    const KANA_COLS = ['あ','い','う','え','お'];
    
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    const formatTime = (ms, formatMode = 'mm:ss') => {
        const totalSeconds = ms / 1000;
        if (formatMode === 'ss') return `${totalSeconds.toFixed(2)}秒`;
        const m = Math.floor(totalSeconds / 60);
        const s = (totalSeconds % 60).toFixed(2);
        return `${m}:${s.padStart(5, '0')}`;
    };
    const getJapaneseEra = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const fullDate = year * 10000 + month * 100 + day;
        if (fullDate >= 20190501) return `令和${year - 2018 === 1 ? '元' : year - 2018}年`;
        if (fullDate >= 19890108) return `平成${year - 1988 === 1 ? '元' : year - 1988}年`;
        if (fullDate >= 19261225) return `昭和${year - 1925 === 1 ? '元' : year - 1925}年`;
        if (fullDate >= 19120730) return `大正${year - 1911 === 1 ? '元' : year - 1911}年`;
        if (fullDate >= 18680125) return `明治${year - 1867 === 1 ? '元' : year - 1867}年`;
        return `${year}年`;
    };

    const translations = {
        ja: {
            appTitle: 'メモリープロ', calendar: 'カレンダー計算', number: 'ナンバー記憶', card: 'トランプ記憶',
            letterPair: 'レターペア', descLP: '2文字をイメージに変換', lpTable: '変換表', lpTraining: 'トレーニング',
            settings: 'アプリ設定', history: '履歴', lang: '表示言語', timerFormat: 'タイマー表示', minSec: '分:秒', onlySec: '秒',
            backup: 'データ管理', export: 'バックアップ作成', import: 'データの復元', reset: 'データを初期化', resetConfirm: '履歴と設定を消去しますか？',
            home: 'ホームへ', penaltyText: 'ミス1問につき30秒加算', start: 'スタート', back: '戻る', result: '結果確認',
            rawTime: 'タイム', penalty: 'ペナルティ', avgTime: '平均タイム', finalScore: 'スコア', retry: 'もう一度', changeRange: '出題範囲変更',
            gameSettings: '設定', countdown: '開始カウント', showNums: 'ボタン番号', digitPairs: '桁数', autoNext: '自動送り', autoNextOff: 'オフ',
            spacing: 'スペース区切り', range: '出題範囲', allRange: '全範囲', yearMode: '表示形式', western: '西暦', era: '和暦', both: '両方',
            next: '次へ', trainingType: '記憶術トレーニング', descCal: '曜日を素早く計算', descNum: '数字をイメージに変換',
            descCard: '52枚のカードを記憶', recent: '最近', birthday: '誕生日', competition: '競技', restart: 'やり直す', bestScore: '最高記録',
            newRecord: '自己ベスト更新！', historyMenu: '履歴', confirmQuit: 'トレーニングを中断してホームに戻りますか？', noData: 'データなし', sec: '秒', lap: 'ラップ',
            mode: '出題範囲', accuracy: '正解数', numConversion: '変換練習', numMemory: '記憶練習', descConversion: 'イメージに変換するのみ',
            descMemory: '記憶して回答する', bunchCount: '束数', digitsPerBunch: '1束あたりの数', digitsPerImage: '1イメージの単位', imagesPerView: '同時表示数',
            separator: '区切り文字', noDuplicates: '重複なし', rangeStart: '開始番号', rangeEnd: '終了番号', autoNextSpeed: '自動送り速度',
            recallInput: '回答入力', checkResult: '採点する', correctRate: '正解率', inputPlace: '入力待機...', none: '(無し)', finish: '終了',
            recall: '回答へ', memorization: '記憶', totalDigits: '総数',
            qCount: '出題数', edit: 'イメージ編集', alwaysShow: '初めから答えを表示', rowSelect: '行選択',
            digitsPerGroup: '1イメージの桁数', totalDigitsNum: '出題数 (記憶練習)', endless: 'エンドレス', fiveSecPenalty: 'ミス1つにつき5秒加算',
            mentalMath: '暗算練習', mentalMathDesc: '10問タイムアタック', remainder: 'あまり', showAnswer: '答えを表示', calcStart: '日付計算スタート',
            sortMode: '出題順', sortRandom: 'ランダム', sortWeak: '苦手順 (NG多い順)', reviewFilter: '復習フィルター', reviewDays: '日以内に出題なし',
            memoryLen: '記憶する文字数', charCount: '文字', accuracyRate: '正解率', totalCount: '総数',
            prev: '前へ', first: '最初へ', finishRecall: '回答する', penalty30s: 'ミス1つにつき30秒加算',
            configureTable: '変換表を編集', allRows: '全行', save: '保存', wordPlaceholder: '単語を入力', practiceRows: '出題行を選択',
            startPair: '練習開始', pass: '正解', fail: '不正解', front: 'ペア', back: 'イメージ', selectRowsMsg: '練習したい行（1文字目）を選んでください',
            tableEditDesc: '1文字目を選択して単語を登録', close: '閉じる'
        },
        en: {
            appTitle: 'MemoryPro', calendar: 'Calendar Calc', number: 'Number Memory', card: 'Card Memory',
            letterPair: 'Letter Pair', descLP: '2-char image conversion', lpTable: 'Conversion Table', lpTraining: 'Training',
            settings: 'Settings', history: 'History', lang: 'Language', timerFormat: 'Timer Format', minSec: 'MM:SS', onlySec: 'Sec',
            backup: 'Data Backup', export: 'Export', import: 'Import', reset: 'Reset', resetConfirm: 'Clear all data?',
            home: 'Home', penaltyText: '30s penalty per mistake', start: 'Start', back: 'Back', result: 'Result',
            rawTime: 'Time', penalty: 'Penalty', avgTime: 'Avg', finalScore: 'Score', retry: 'Retry', changeRange: 'Change Range',
            gameSettings: 'Settings', countdown: 'Countdown', showNums: 'Index', digitPairs: 'Digits', autoNext: 'Auto', autoNextOff: 'Off',
            spacing: 'Spacing', range: 'Range', allRange: 'All', yearMode: 'Year Style', western: 'Western', era: 'Era', both: 'Both',
            next: 'Next', trainingType: 'Memory Training', descCal: 'Day of week calc', descNum: 'Number conversion',
            descCard: 'Card memorization', recent: 'Recent', birthday: 'Birthday', competition: 'Competition', restart: 'Restart', bestScore: 'Best',
            newRecord: 'New Best!', historyMenu: 'History', confirmQuit: 'Quit training?', noData: 'No Data', sec: 's', lap: 'Lap',
            mode: 'Mode', accuracy: 'Accuracy', numConversion: 'Conversion', numMemory: 'Memory', descConversion: 'Images only',
            descMemory: 'Memorize & Recall', bunchCount: 'Decks', digitsPerBunch: 'Items/Deck', digitsPerImage: 'Items/Img', imagesPerView: 'Images/View',
            separator: 'Separator', noDuplicates: 'No Dupes', rangeStart: 'Start #', rangeEnd: 'End #', autoNextSpeed: 'Auto Speed',
            recallInput: 'Recall Input', checkResult: 'Check', correctRate: 'Accuracy', inputPlace: 'Waiting...', none: '(None)', finish: 'Finish',
            recall: 'Recall', memorization: 'Memorize', totalDigits: 'Total',
            qCount: 'Count', edit: 'Edit Image', alwaysShow: 'Show Answer Always', rowSelect: 'Row Select',
            digitsPerGroup: 'Digits per Image', totalDigitsNum: 'Total Digits (Memory)', endless: 'Endless', fiveSecPenalty: '+5s per mistake',
            mentalMath: 'Mental Math', mentalMathDesc: '10 Questions Time Attack', remainder: 'Remainder', showAnswer: 'Show Answer', calcStart: 'Start Date Calc',
            sortMode: 'Sort Order', sortRandom: 'Random', sortWeak: 'Weakest First', reviewFilter: 'Review Filter', reviewDays: 'days since last view',
            memoryLen: 'Memory Length', charCount: 'chars', accuracyRate: 'Accuracy', totalCount: 'Total',
            prev: 'Prev', first: 'First', finishRecall: 'Recall Now', penalty30s: '+30s per mistake',
            configureTable: 'Edit Table', allRows: 'All Rows', save: 'Save', wordPlaceholder: 'Enter word', practiceRows: 'Select Rows',
            startPair: 'Start Practice', pass: 'Pass', fail: 'Fail', front: 'Pair', back: 'Image', selectRowsMsg: 'Select rows (1st char) to practice',
            tableEditDesc: 'Select row to edit words', close: 'Close'
        }
    };

    const handleHomeWithConfirm = (gameState, onBack, t) => {
        const safeStates = ['menu', 'idle', 'finished', 'result', 'math_result', 'conversion', 'lp_menu'];
        if (!safeStates.includes(gameState)) {
            if (window.confirm(t.confirmQuit)) onBack();
        } else {
            onBack();
        }
    };

    const MemoryNavControls = ({ onFirst, onPrev, onNext, onFinish, current, total, t }) => {
        return (
            <div className="w-full max-w-sm grid grid-cols-4 gap-2 mt-auto pt-4">
                <button onClick={onFirst} className="bg-slate-100 text-slate-500 rounded-xl h-14 flex items-center justify-center text-lg hover:bg-slate-200 active:scale-95 transition-all"><i className="fa-solid fa-backward-step"></i></button>
                <button onClick={onPrev} className="bg-slate-100 text-slate-500 rounded-xl h-14 flex items-center justify-center text-lg hover:bg-slate-200 active:scale-95 transition-all"><i className="fa-solid fa-chevron-left"></i></button>
                <button onClick={onNext} className="bg-slate-800 text-white rounded-xl h-14 flex items-center justify-center text-lg hover:bg-slate-700 active:scale-95 transition-all">
                    {current + 1 >= total ? t.recall : <i className="fa-solid fa-chevron-right"></i>}
                </button>
                <button onClick={onFinish} className="bg-green-100 text-green-600 rounded-xl h-14 flex items-center justify-center text-xl hover:bg-green-200 active:scale-95 transition-all"><i className="fa-solid fa-check"></i></button>
            </div>
        );
    };

    const GlobalSettingsModal = ({ globalSettings, setGlobalSettings, onClose, t }) => {
        if (!t) return null;
        const handleReset = () => { if (window.confirm(t.resetConfirm)) { localStorage.clear(); window.location.reload(); } };
        const handleExport = () => {
            const data = { ...localStorage };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `memorypro_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };
        const handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                    if (data.global_settings) setGlobalSettings(JSON.parse(data.global_settings));
                    alert('インポート完了。'); window.location.reload();
                } catch (err) { alert('不正なファイル形式です。'); }
            };
            reader.readAsText(file);
        };

        return (
            <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
                <div className="bg-white w-full max-w-lg rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl p-6 overflow-y-auto max-h-[85vh] no-scrollbar">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2">
                            <i className="fa-solid fa-sliders text-indigo-600"></i> {t.settings}
                        </h2>
                        <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition-colors"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <div className="space-y-6">
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.countdown}</label>
                            <div className="grid grid-cols-3 gap-2">
                                {[3, 5, 10].map(s => (
                                    <button key={s} onClick={() => setGlobalSettings(prev => ({...prev, countdownSeconds: s}))} 
                                        className={`py-2.5 rounded-xl border-2 font-bold text-sm transition-all ${globalSettings.countdownSeconds === s ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-100 text-slate-400 hover:border-slate-200'}`}>
                                        {s}{t.sec}
                                    </button>
                                ))}
                            </div>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">{t.lang}</label>
                            <div className="grid grid-cols-2 gap-2">
                                {['ja', 'en'].map(l => (
                                    <button key={l} onClick={() => setGlobalSettings(s => ({...s, lang: l}))} className={`py-3 rounded-xl border-2 font-bold text-sm transition-all ${globalSettings.lang === l ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-100 text-slate-400 hover:border-slate-200'}`}>
                                        {l === 'ja' ? '日本語' : 'English'}
                                    </button>
                                ))}
                            </div>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">{t.backup}</label>
                            <div className="space-y-2">
                                <button onClick={handleExport} className="w-full py-4 bg-slate-50 hover:bg-slate-100 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-colors"><i className="fa-solid fa-download"></i> {t.export}</button>
                                <label className="w-full py-4 bg-slate-50 hover:bg-slate-100 rounded-xl font-bold text-sm flex items-center justify-center gap-2 cursor-pointer transition-colors"><i className="fa-solid fa-upload"></i> {t.import}<input type="file" accept=".json" onChange={handleImport} className="hidden" /></label>
                                <button onClick={handleReset} className="w-full py-4 bg-red-50 text-red-500 rounded-xl font-bold text-sm border border-red-100 flex items-center justify-center gap-2 hover:bg-red-100 transition-colors">{t.reset}</button>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        );
    };

    const Card = ({ suit, value, className = "" }) => {
        const isRed = suit === 'heart' || suit === 'diamond';
        const colorClass = isRed ? 'text-red-500' : 'text-slate-800';
        
        return (
            <div className={`bg-white rounded-lg border border-slate-300 card-shadow flex flex-col items-center justify-center relative select-none overflow-hidden ${className}`}>
                {/* Top Left Index */}
                <div className={`absolute top-1 left-1.5 flex flex-col items-center leading-none ${colorClass}`}>
                    <span className="text-sm font-bold tracking-tighter">{value}</span>
                    <span className="text-[10px]">{SUIT_ICONS[suit]}</span>
                </div>
                
                {/* Center Content: Large Suit + Value */}
                <div className={`w-full h-full flex flex-col items-center justify-center ${colorClass}`}>
                    <div className="text-4xl sm:text-6xl mb-1">{SUIT_ICONS[suit]}</div>
                    <div className="text-4xl sm:text-6xl font-black">{value}</div>
                </div>

                {/* Bottom Right Index */}
                <div className={`absolute bottom-1 right-1.5 flex flex-col items-center leading-none rotate-180 ${colorClass}`}>
                    <span className="text-sm font-bold tracking-tighter">{value}</span>
                    <span className="text-[10px]">{SUIT_ICONS[suit]}</span>
                </div>
            </div>
        );
    };

    const HistoryModal = ({ history, range, onClose, t, formatTime }) => {
        const [expandedId, setExpandedId] = useState(null);
        const filtered = history.filter(h => h.range === range);
        const top10 = filtered.slice(0, 10);
        const toggle = (id) => setExpandedId(expandedId === id ? null : id);
        return (
            <div className="fixed inset-0 z-[120] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                    <div className="flex justify-between items-center mb-6 flex-none">
                        <h3 className="text-xl font-bold flex items-center gap-2 text-slate-800">
                            <i className="fa-solid fa-clock-rotate-left text-indigo-500"></i> {t.historyMenu} 
                            <span className="text-[10px] bg-indigo-50 px-3 py-1 rounded-full text-indigo-600 font-black uppercase tracking-widest ml-1">{t[range] || range}</span>
                        </h3>
                        <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition-colors"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <div className="overflow-y-auto no-scrollbar space-y-3 flex-grow">
                        {top10.length === 0 && <div className="text-center text-slate-400 py-4 font-bold">{t.noData}</div>}
                        {top10.map((h, i) => {
                            const correctCount = h.laps ? h.laps.filter(l => l.correct).length : (h.accuracy || 0);
                            const isExpanded = expandedId === i;
                            return (
                                <div key={i} className={`p-4 rounded-xl border transition-all cursor-pointer ${isExpanded ? 'bg-indigo-50 border-indigo-200 shadow-sm' : 'bg-slate-50 border-slate-100 hover:bg-slate-100'}`} onClick={() => toggle(i)}>
                                    <div className="flex justify-between items-center">
                                        <div className="text-xs font-bold text-slate-500">
                                            {new Date(h.timestamp).toLocaleString(undefined, {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'})}
                                        </div>
                                        <div className="font-mono font-black text-slate-800 text-lg">
                                            {formatTime(h.finalScore, h.settings?.timerFormat || 'mm:ss')}
                                            <i className={`fa-solid fa-chevron-down ml-3 text-xs text-slate-300 transition-transform ${isExpanded ? 'rotate-180 text-indigo-500' : ''}`}></i>
                                        </div>
                                    </div>
                                    {isExpanded && (
                                        <div className="mt-4 pt-4 border-t border-indigo-100 space-y-3">
                                            <div className="flex justify-between text-xs font-bold">
                                                <span className="text-slate-400 uppercase">{t.accuracy}</span>
                                                <span className="text-indigo-600">{h.accuracy !== undefined ? h.accuracy : correctCount}</span>
                                            </div>
                                            <div className="flex justify-between text-xs font-bold">
                                                <span className="text-slate-400 uppercase">{t.penalty}</span>
                                                <span className={h.penaltySeconds > 0 ? 'text-red-500' : 'text-green-500'}>+{h.penaltySeconds}s</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    </div>
            </div>
        );
    };

    const CalendarTrainer = ({ onBack, globalSettings, t }) => {
        const [gameState, setGameState] = useState('idle');
        const [isLocalSettingsOpen, setIsLocalSettingsOpen] = useState(false);
        const [isHistoryOpen, setIsHistoryOpen] = useState(false);
        const [selectedRange, setSelectedRange] = useState('birthday');
        const [activeQuestion, setActiveQuestion] = useState(0);
        const [questions, setQuestions] = useState([]);
        const [laps, setLaps] = useState([]);
        const [startTime, setStartTime] = useState(0);
        const [currentTime, setCurrentTime] = useState(0);
        const [feedback, setFeedback] = useState(null);
        const [countdownText, setCountdownText] = useState('');
        
        const [mathQuestion, setMathQuestion] = useState(null);
        const [mathStats, setMathStats] = useState({ count: 0, correct: 0 });
        const [mathFeedback, setMathFeedback] = useState(null);
        const [mathStartTime, setMathStartTime] = useState(0);
        const [mathEndTime, setMathEndTime] = useState(0);
        const [mathRecords, setMathRecords] = useState(() => JSON.parse(localStorage.getItem('calendar_math_records_v2') || '[]'));

        const [settings, setSettings] = useState(() => {
            const saved = localStorage.getItem('calendar_settings');
            return saved ? JSON.parse(saved) : { yearMode: 'western', showNumbers: true, startDay: 0, timerFormat: 'mm:ss' };
        });
        const [currentSessionId, setCurrentSessionId] = useState(null);
        const [isNewRecord, setIsNewRecord] = useState(false);
        const [currentResult, setCurrentResult] = useState(null);

        const timerRef = useRef(null);
        const updateTimer = useCallback(() => {
            if (gameState === 'playing' || gameState === 'playing_math') {
                setCurrentTime(performance.now());
                timerRef.current = requestAnimationFrame(updateTimer);
            }
        }, [gameState]);
        useEffect(() => {
            if (gameState === 'playing' || gameState === 'playing_math') timerRef.current = requestAnimationFrame(updateTimer);
            else if (timerRef.current) cancelAnimationFrame(timerRef.current);
            return () => { if (timerRef.current) cancelAnimationFrame(timerRef.current); };
        }, [gameState, updateTimer]);

        const generateRandomDate = (range) => {
            let startYear, endYear;
            const now = new Date();
            if (range === 'birthday') { startYear = now.getFullYear() - 80; endYear = now.getFullYear(); }
            else if (range === 'competition') { startYear = 1500; endYear = 2500; }
            else { startYear = now.getFullYear() - 1; endYear = now.getFullYear() + 1; }
            const year = Math.floor(Math.random() * (endYear - startYear + 1)) + startYear;
            const month = Math.floor(Math.random() * 12);
            const day = Math.floor(Math.random() * 28) + 1;
            return new Date(year, month, day);
        };

        const startCountdown = () => {
            setLaps([]); setFeedback(null); setGameState('countdown');
            setIsNewRecord(false); setCurrentResult(null); setCurrentSessionId(generateId());
            setQuestions(Array.from({ length: 5 }, () => generateRandomDate(selectedRange)));
            let count = globalSettings.countdownSeconds || 3;
            setCountdownText(count.toString());
            const interval = window.setInterval(() => {
                count -= 1;
                if (count === 0) setCountdownText('START!');
                else if (count < 0) { clearInterval(interval); startTraining(); }
                else setCountdownText(count.toString());
            }, 1000);
        };

        const startTraining = () => { setActiveQuestion(0); setGameState('playing'); const now = performance.now(); setStartTime(now); setCurrentTime(now); };
        const handleAnswer = (dayIndex) => {
            if (gameState !== 'playing' || feedback) return;
            const targetDate = questions[activeQuestion];
            const correctDayIndex = targetDate.getDay();
            const isCorrect = dayIndex === correctDayIndex;
            const now = performance.now();
            const prevTotalDuration = laps.reduce((acc, l) => acc + l.duration, 0);
            const questionDuration = (now - startTime) - prevTotalDuration;
            const record = { questionNumber: activeQuestion + 1, date: formatDate(targetDate), correct: isCorrect, duration: questionDuration, userAnswer: (globalSettings.lang === 'ja' ? DAYS_JP_LONG : DAYS_EN_LONG)[dayIndex], correctAnswer: (globalSettings.lang === 'ja' ? DAYS_JP_LONG : DAYS_EN_LONG)[correctDayIndex] };
            setFeedback({ index: activeQuestion, isCorrect });
            setLaps(prev => [...prev, record]);
            setTimeout(() => {
                setFeedback(null);
                if (activeQuestion < 4) setActiveQuestion(prev => prev + 1);
                else {
                    const finalTime = now - startTime;
                    const mistakes = [...laps, record].filter(l => !l.correct).length;
                    const session = { id: currentSessionId, timestamp: Date.now(), range: selectedRange, totalTime: finalTime, penaltySeconds: mistakes * 30, finalScore: finalTime + (mistakes * 30000), laps: [...laps, record], settings };
                    const history = JSON.parse(localStorage.getItem('calendar_history') || '[]');
                    history.unshift(session);
                    localStorage.setItem('calendar_history', JSON.stringify(history.slice(0, 100)));
                    const records = JSON.parse(localStorage.getItem('calendar_records') || '[]');
                    const existingIndex = records.findIndex(r => r.range === selectedRange);
                    let newBest = false;
                    if (existingIndex >= 0) { if (session.finalScore < records[existingIndex].finalScore) { records[existingIndex] = session; newBest = true; } } else { records.push(session); newBest = true; }
                    if (newBest) { localStorage.setItem('calendar_records', JSON.stringify(records)); setIsNewRecord(true); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); }
                    setCurrentResult(session); setGameState('finished');
                }
            }, 300);
        };

        const generateMathQuestion = () => {
            const n1 = Math.random() < 0.5 ? 0 : 1; 
            const n2 = Math.floor(Math.random() * 7);
            const n3 = Math.floor(Math.random() * 7); 
            const n4 = Math.floor(Math.random() * 31) + 1;
            return { n1, n2, n3, n4, answer: (n1 + n2 + n3 + n4) % 7 };
        };

        const startMathCountdown = () => {
            setGameState('math_countdown');
            let count = globalSettings.countdownSeconds || 3;
            setCountdownText(count.toString());
            const interval = setInterval(() => {
                count--;
                if (count === 0) setCountdownText('START!');
                else if (count < 0) { clearInterval(interval); startMathGame(); }
                else setCountdownText(count.toString());
            }, 1000);
        };

        const startMathGame = () => {
            setGameState('playing_math');
            setMathStats({ count: 1, correct: 0 });
            setMathFeedback(null);
            setMathQuestion(generateMathQuestion());
            const now = performance.now();
            setMathStartTime(now);
            setCurrentTime(now);
            setIsNewRecord(false);
        };

        const handleMathAnswer = (val) => {
            if(mathFeedback) return;
            const isCorrect = val === mathQuestion.answer;
            setMathFeedback(isCorrect ? 'correct' : 'wrong');
            const newCorrect = mathStats.correct + (isCorrect ? 1 : 0);
            setTimeout(() => {
                setMathFeedback(null);
                if(mathStats.count < 10) {
                    setMathStats(prev => ({ count: prev.count + 1, correct: newCorrect }));
                    setMathQuestion(generateMathQuestion());
                } else {
                    finishMathGame(newCorrect);
                }
            }, 300);
        };

        const finishMathGame = (finalCorrect) => {
            const endTime = performance.now();
            setMathEndTime(endTime);
            const rawTime = endTime - mathStartTime;
            const mistakes = 10 - finalCorrect;
            const penalty = mistakes * 5000;
            const totalScore = rawTime + penalty;
            const avgScore = totalScore / 10;
            const newRecord = { timestamp: Date.now(), rawTime, correct: finalCorrect, penalty, totalScore, avgScore };
            const currentRecords = [...mathRecords];
            const updatedRecords = [...currentRecords, newRecord].sort((a,b) => a.totalScore - b.totalScore).slice(0, 50);
            localStorage.setItem('calendar_math_records_v2', JSON.stringify(updatedRecords));
            setMathRecords(updatedRecords);
            if (updatedRecords.length > 0 && updatedRecords[0].timestamp === newRecord.timestamp) {
                    setIsNewRecord(true); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            } else { setIsNewRecord(false); }
            setMathStats(prev => ({ ...prev, correct: finalCorrect, penalty, totalScore, avgScore, rawTime }));
            setGameState('math_result');
        };

        const getMathBestScore = () => { if(mathRecords.length === 0) return null; return mathRecords[0].avgScore; };
        const getBestScore = (range) => {
            const records = JSON.parse(localStorage.getItem('calendar_records') || '[]');
            const filtered = records.filter(r => r.range === range);
            if (filtered.length === 0) return null;
            return Math.min(...filtered.map(r => r.finalScore));
        };
        const handleHomeClick = () => handleHomeWithConfirm(gameState, onBack, t);
        const formatDate = (date) => {
            const y = date.getFullYear(), m = date.getMonth() + 1, d = date.getDate(), era = getJapaneseEra(date);
            if (settings.yearMode === 'japanese') return `${era} ${m}月${d}日`;
            if (settings.yearMode === 'both') return `${y}年 (${era}) ${m}月${d}日`;
            return `${y}年 ${m}月${d}日`;
        };
        const updateLocalSettings = (key, val) => { const ns = {...settings, [key]: val}; setSettings(ns); localStorage.setItem('calendar_settings', JSON.stringify(ns)); };
        const dayList = useMemo(() => {
            const list = (globalSettings.lang === 'ja' ? DAYS_JP : DAYS_EN).map((label, index) => ({ label, index }));
            if (settings.startDay === 1) { const mon = list.slice(1); mon.push(list[0]); return mon; }
            return list;
        }, [settings.startDay, globalSettings.lang]);

        if (gameState === 'idle') return (
            <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                <div className="flex justify-between items-center mb-6">
                    <button onClick={handleHomeClick} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-indigo-600 transition-colors z-50"><i className="fa-solid fa-house"></i></button>
                    <h2 className="text-lg font-bold text-slate-800">{t.calendar}</h2>
                    <button onClick={() => setIsLocalSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-indigo-600 transition-colors"><i className="fa-solid fa-cog"></i></button>
                </div>
                <div className="flex-grow flex flex-col items-center justify-center text-center gap-6 max-w-sm mx-auto w-full">
                    <div className="w-full">
                        <label className="text-xs font-bold text-slate-400 uppercase tracking-widest block mb-2 text-left">{t.range}</label>
                        <select value={selectedRange} onChange={(e) => setSelectedRange(e.target.value)} className="w-full p-4 border-2 border-slate-100 rounded-2xl font-bold text-slate-700 bg-white shadow-sm outline-none focus:border-indigo-200">
                            {['birthday', 'recent', 'competition'].map(r => <option key={r} value={r}>{t[r] || r}</option>)}
                        </select>
                    </div>
                    <button onClick={startCountdown} className="w-full py-6 bg-indigo-600 text-white rounded-[2rem] shadow-lg active:scale-95 transition-all text-left px-8 relative overflow-hidden group">
                        <div className="relative z-10"><div className="text-2xl font-black mb-1">{t.calcStart}</div><div className="text-xs font-bold opacity-70">{t.descCal}</div></div>
                        <div className="absolute right-6 top-1/2 -translate-y-1/2 text-4xl opacity-20 group-hover:scale-110 transition-transform"><i className="fa-solid fa-play"></i></div>
                    </button>
                    <button onClick={startMathCountdown} className="w-full py-6 bg-white border-2 border-indigo-100 text-indigo-600 rounded-[2rem] shadow-sm active:scale-95 transition-all text-left px-8 relative overflow-hidden group hover:border-indigo-200">
                        <div className="relative z-10"><div className="text-xl font-black mb-1">{t.mentalMath}</div><div className="text-xs font-bold text-slate-400">{t.mentalMathDesc}</div></div>
                        <div className="absolute right-6 top-1/2 -translate-y-1/2 text-3xl opacity-10 group-hover:scale-110 transition-transform"><i className="fa-solid fa-calculator"></i></div>
                    </button>
                    <button onClick={() => setIsHistoryOpen(true)} className="flex items-center gap-2 text-slate-400 font-bold text-sm hover:text-indigo-600 transition-colors mt-4"><i className="fa-solid fa-clock-rotate-left"></i> {t.historyMenu}</button>
                </div>
                {isLocalSettingsOpen && (
                    <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-y-auto max-h-[80vh] no-scrollbar">
                            <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-slate-800"><i className="fa-solid fa-cog text-indigo-500"></i> {t.gameSettings}</h3>
                            <div className="space-y-5">
                                <section>
                                    <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.yearMode}</label>
                                    <div className="grid grid-cols-3 gap-2">{['western', 'japanese', 'both'].map(m => <button key={m} onClick={() => updateLocalSettings('yearMode', m)} className={`py-2.5 rounded-xl border-2 font-bold text-xs transition-all ${settings.yearMode === m ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>{m === 'japanese' ? t.era : t[m] || m}</button>)}</div>
                                </section>
                                <section>
                                    <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.timerFormat}</label>
                                    <div className="grid grid-cols-2 gap-2">{['mm:ss', 'ss'].map(f => <button key={f} onClick={() => updateLocalSettings('timerFormat', f)} className={`py-2.5 rounded-xl border-2 font-bold text-xs transition-all ${settings.timerFormat === f ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>{f === 'mm:ss' ? t.minSec : t.onlySec}</button>)}</div>
                                </section>
                                <section>
                                    <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.showNums}</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => updateLocalSettings('showNumbers', true)} className={`py-2.5 rounded-xl border-2 font-bold text-xs transition-all ${settings.showNumbers ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>ON</button>
                                        <button onClick={() => updateLocalSettings('showNumbers', false)} className={`py-2.5 rounded-xl border-2 font-bold text-xs transition-all ${!settings.showNumbers ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>OFF</button>
                                    </div>
                                </section>
                            </div>
                            <button onClick={() => setIsLocalSettingsOpen(false)} className="w-full mt-8 py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-all">{t.close}</button>
                        </div>
                    </div>
                )}
                {isHistoryOpen && <HistoryModal history={JSON.parse(localStorage.getItem('calendar_history') || '[]')} range={selectedRange} onClose={() => setIsHistoryOpen(false)} t={t} formatTime={formatTime} />}
            </div>
        );
        
        if (gameState === 'countdown' || gameState === 'math_countdown') return <div className="h-full flex items-center justify-center bg-indigo-600 text-white"><div className="text-8xl font-black animate-countdown px-4 text-center">{countdownText}</div></div>;
        if (gameState === 'playing') return (
            <div className="h-full flex flex-col p-4 overflow-hidden">
                <div className="flex justify-between items-start mb-2 flex-none">
                    <button onClick={handleHomeClick} className="text-slate-400 hover:text-slate-600 py-2 z-50"><i className="fa-solid fa-house"></i></button>
                    <div className="flex flex-col items-center"><span className="text-5xl font-mono font-black text-slate-800 tracking-tighter">{formatTime(currentTime - startTime, settings.timerFormat)}</span></div>
                    <button onClick={startCountdown} className="text-slate-400 hover:text-slate-600 py-2 text-sm font-bold flex flex-col items-center gap-1 transition-colors"><i className="fa-solid fa-rotate-right"></i> {t.restart}</button>
                </div>
                <div className="text-center mb-4 flex-none"><span className="text-[10px] font-black text-indigo-600 uppercase tracking-[0.2em]">{activeQuestion + 1} / 5</span></div>
                <div className="space-y-2 overflow-y-auto no-scrollbar py-2 h-[45vh] flex-none">
                    {questions.map((q, idx) => {
                        const isAnswered = idx < laps.length; const isActive = idx === activeQuestion; const lap = laps[idx];
                        return (<div key={idx} className={`p-4 rounded-2xl transition-all duration-300 ${isActive ? 'bg-indigo-50 scale-[1.02]' : isAnswered ? 'bg-slate-50 opacity-60' : 'opacity-20 blur-[1px]'}`}><div className="flex items-center justify-between"><div className="flex items-center gap-3"><div className={`w-6 h-6 rounded-full flex items-center justify-center font-bold text-[10px] ${isActive ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'}`}>{idx + 1}</div><span className={`font-bold ${isActive ? 'text-lg' : 'text-sm'}`}>{isActive || isAnswered ? formatDate(q) : '????年??月??日'}</span></div>{isAnswered && (<div className="text-base font-bold text-slate-500 ml-auto">({lap.userAnswer})</div>)}</div></div>);
                    })}
                </div>
                <div className="flex-grow flex items-start justify-center pt-4"><div className="grid grid-cols-7 gap-1 w-full max-w-sm">{dayList.map(({ label, index }) => (<button key={label} onClick={() => handleAnswer(index)} className={`aspect-[3/4] flex flex-col items-center justify-center gap-1 rounded-xl shadow-sm border active:scale-95 transition-transform ${index === 0 ? 'text-red-500 bg-red-50 border-red-100' : index === 6 ? 'text-blue-500 bg-blue-50 border-blue-100' : 'bg-white border-slate-200 text-slate-700'}`}><span className="font-bold text-lg sm:text-xl">{label}</span>{settings.showNumbers && <span className="text-[10px] font-black opacity-40">{index}</span>}</button>))}</div></div>
            </div>
        );
        if (gameState === 'playing_math') {
            return (
                <div className="h-full flex flex-col p-6 bg-indigo-50">
                    <div className="flex justify-between items-start mb-6 flex-none">
                        <button onClick={handleHomeClick} className="text-indigo-300 hover:text-indigo-600 py-2 z-50"><i className="fa-solid fa-house"></i></button>
                        <div className="flex flex-col items-center"><span className="text-5xl font-mono font-black text-slate-800 tracking-tighter">{formatTime(currentTime - mathStartTime, settings.timerFormat)}</span></div>
                        <button onClick={startMathCountdown} className="text-indigo-300 hover:text-indigo-600 py-2 flex flex-col items-center gap-1 transition-colors"><i className="fa-solid fa-rotate-right"></i></button>
                    </div>
                    <div className="text-center mb-8 flex-none"><span className="text-xs font-black text-indigo-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full">{mathStats.count} / 10</span></div>
                    <div className="flex-grow flex flex-col items-center justify-center relative">
                        {mathFeedback && (<div className="absolute inset-0 flex items-center justify-center z-10 animate-pop">{mathFeedback === 'correct' ? <i className="fa-regular fa-circle text-9xl text-green-500 opacity-80 drop-shadow-lg"></i> : <i className="fa-solid fa-xmark text-9xl text-red-500 opacity-80 drop-shadow-lg"></i>}</div>)}
                        <div className="bg-white p-8 rounded-[2rem] shadow-sm w-full max-w-sm border-2 border-indigo-100">
                            <div className="text-4xl sm:text-5xl font-black text-slate-700 text-center tracking-tight mb-4 flex justify-center gap-1 sm:gap-2"><span>{mathQuestion.n1}</span><span className="text-indigo-300">+</span><span>{mathQuestion.n2}</span><span className="text-indigo-300">+</span><span>{mathQuestion.n3}</span><span className="text-indigo-300">+</span><span>{mathQuestion.n4}</span></div>
                            <div className="flex justify-center"><div className="inline-block border-t-4 border-indigo-100 px-10 pt-2 text-2xl font-bold text-slate-400">÷ 7</div></div>
                        </div>
                    </div>
                    <div className="mt-auto pt-8 max-w-sm mx-auto w-full">
                        <div className="grid grid-cols-3 gap-3">
                            {[1, 2, 3, 4, 5, 6].map(n => (<button key={n} onClick={() => handleMathAnswer(n)} className="h-20 bg-white rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 active:bg-slate-50 transition-all text-3xl font-black text-slate-700">{n}</button>))}
                            <div className="col-start-2"><button onClick={() => handleMathAnswer(0)} className="w-full h-20 bg-white rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 active:bg-slate-50 transition-all text-3xl font-black text-slate-700">0</button></div>
                        </div>
                    </div>
                </div>
            );
        }
        if (gameState === 'math_result') {
                const bestAvg = getMathBestScore();
                return (
                <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6 pt-2">
                        <div><h2 className="text-2xl font-black flex items-center gap-3 text-slate-800"><i className="fa-solid fa-calculator text-indigo-500"></i> {t.result}</h2></div>
                        <div className="flex gap-2"><button onClick={handleHomeClick} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm transition-all hover:text-indigo-600 z-50"><i className="fa-solid fa-house"></i></button></div>
                    </div>
                    <div className="w-full bg-indigo-600 text-white rounded-[2.5rem] p-8 sm:p-10 mb-8 shadow-2xl relative flex flex-col items-center text-center">
                        {isNewRecord && (<div className="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-[10px] font-black px-4 py-1.5 rounded-bl-2xl uppercase tracking-widest shadow-md">{t.newRecord}</div>)}
                        <div className="text-[11px] font-black opacity-60 uppercase tracking-widest mb-1">{t.finalScore} <span className="text-[10px] opacity-80 normal-case">(Avg)</span></div>
                        <div className="text-6xl sm:text-7xl font-mono font-black mb-4 tracking-tighter drop-shadow-lg truncate w-full">{formatTime(mathStats.avgScore, 'ss')}</div>
                        <div className="flex items-center gap-2 mb-10 bg-black/10 px-5 py-2 rounded-full"><i className="fa-solid fa-crown text-yellow-400 text-xs"></i><span className="text-sm font-black tracking-widest uppercase">{t.bestScore}: {bestAvg ? formatTime(bestAvg, 'ss') : '-'}</span></div>
                        <div className="w-full pt-8 border-t border-white/20">
                            <div className="grid grid-cols-2 gap-4">
                                    <div className="flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.rawTime}</div><div className="font-mono font-black text-xl tracking-tight">{formatTime(mathStats.rawTime, settings.timerFormat)}</div></div>
                                    <div className="flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.penalty}</div><div className="font-mono font-black text-xl tracking-tight text-red-300">+{mathStats.penalty / 1000}s</div></div>
                            </div>
                            <div className="mt-4 flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.accuracy}</div><div className="font-mono font-black text-2xl tracking-tight">{mathStats.correct} / 10</div></div>
                        </div>
                    </div>
                        <div className="space-y-4 pb-12 mt-auto">
                        <button onClick={startMathCountdown} className="w-full py-6 bg-indigo-600 text-white text-xl font-black rounded-[2rem] shadow-lg hover:shadow-xl active:scale-95 transition-all"><i className="fa-solid fa-rotate-right mr-3"></i> {t.retry}</button>
                        <button onClick={() => setGameState('idle')} className="w-full py-6 bg-white border-2 border-slate-100 text-slate-600 text-xl font-black rounded-[2rem] active:scale-95 transition-all"><i className="fa-solid fa-check mr-3"></i> {t.finish}</button>
                    </div>
                </div>
                );
        }
        if (gameState === 'finished') {
            if (!currentResult) return null; const avg = currentResult.totalTime / 5; const best = getBestScore(selectedRange); const correctCount = currentResult.laps.filter(l => l.correct).length;
            return (
                <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6 pt-2"><div><h2 className="text-2xl font-black flex items-center gap-3 text-slate-800"><i className="fa-solid fa-award text-amber-500"></i> {t.result}</h2><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">{t.mode}: {t[selectedRange] || selectedRange}</span></div><div className="flex gap-2"><button onClick={() => setIsHistoryOpen(true)} className="w-10 h-10 flex items-center justify-center bg-indigo-50 rounded-full text-indigo-600 shadow-sm transition-all hover:bg-indigo-100"><i className="fa-solid fa-clock-rotate-left"></i></button><button onClick={handleHomeClick} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm transition-all hover:text-indigo-600 z-50"><i className="fa-solid fa-house"></i></button></div></div>
                    <div className="w-full bg-indigo-600 text-white rounded-[2.5rem] p-8 sm:p-10 mb-8 shadow-2xl relative flex flex-col items-center text-center">{isNewRecord && (<div className="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-[10px] font-black px-4 py-1.5 rounded-bl-2xl uppercase tracking-widest shadow-md">{t.newRecord}</div>)}<div className="text-[11px] font-black opacity-60 uppercase tracking-widest mb-1">{t.finalScore}</div><div className="text-6xl sm:text-7xl font-mono font-black mb-4 tracking-tighter drop-shadow-lg truncate w-full">{formatTime(currentResult.finalScore, settings.timerFormat)}</div><div className="flex items-center gap-2 mb-10 bg-black/10 px-5 py-2 rounded-full"><i className="fa-solid fa-crown text-yellow-400 text-xs"></i><span className="text-sm font-black tracking-widest uppercase">{t.bestScore}: {best ? formatTime(best, settings.timerFormat) : '-'}</span></div><div className="w-full space-y-8 pt-8 border-t border-white/20"><div className="grid grid-cols-2 w-full gap-4"><div className="flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.rawTime}</div><div className="font-mono font-black text-2xl">{formatTime(currentResult.totalTime, settings.timerFormat)}</div></div><div className="flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.accuracy}</div><div className="font-mono font-black text-2xl tracking-tight">{correctCount} / 5</div></div></div><div className="grid grid-cols-2 w-full gap-4"><div className="flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.avgTime}</div><div className="font-mono font-black text-2xl tracking-tight">{formatTime(avg, 'ss')}</div></div><div className="flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.penalty}</div><div className={`font-mono font-black text-2xl tracking-tight ${currentResult.penaltySeconds > 0 ? 'text-red-300' : 'text-green-300'}`}>+{currentResult.penaltySeconds}s</div></div></div></div></div>
                    <div className="mb-10 space-y-4">{currentResult.laps.map((lap, i) => (<div key={i} className="bg-white rounded-3xl p-5 border border-slate-100 flex items-center justify-between shadow-sm hover:shadow-md transition-shadow"><div className="flex items-center gap-4"><div className={`w-8 h-8 rounded-2xl flex items-center justify-center font-black text-xs ${lap.correct ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{i + 1}</div><div className="flex flex-col"><span className="text-[10px] text-slate-400 font-black tracking-wider mb-0.5 uppercase">{lap.date}</span><span className="text-base font-bold text-slate-700">{lap.userAnswer} {!lap.correct && <span className="text-red-400 font-black ml-1">→ {lap.correctAnswer}</span>}</span></div></div><div className="flex flex-col items-end gap-1"><div className="text-xs font-mono font-black text-slate-400 tracking-tight">{formatTime(lap.duration, 'ss')}</div>{lap.correct ? <i className="fa-solid fa-circle-check text-green-500"></i> : <i className="fa-solid fa-circle-xmark text-red-400"></i>}</div></div>))}</div>
                    <div className="space-y-4 pb-12 mt-auto"><button onClick={startCountdown} className="w-full py-6 bg-indigo-600 text-white text-xl font-black rounded-[2rem] shadow-lg hover:shadow-xl active:scale-95 transition-all"><i className="fa-solid fa-rotate-right mr-3"></i> {t.retry}</button><button onClick={() => setGameState('idle')} className="w-full py-6 bg-white border-2 border-slate-100 text-slate-600 text-xl font-black rounded-[2rem] active:scale-95 transition-all"><i className="fa-solid fa-check mr-3"></i> {t.finish}</button></div>
                    {isHistoryOpen && <HistoryModal history={JSON.parse(localStorage.getItem('calendar_history') || '[]')} range={selectedRange} onClose={() => setIsHistoryOpen(false)} t={t} formatTime={formatTime} />}
                </div>
            );
        }
    };

    const CardSettingsModal = ({ settings, updateSettings, onClose, t }) => {
        return (
            <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-y-auto max-h-[85vh] no-scrollbar">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-lg font-bold flex items-center gap-2 text-slate-800"><i className="fa-solid fa-cog text-rose-500"></i> {t.gameSettings}</h3>
                        <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <div className="space-y-5">
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.bunchCount}</label>
                            <select value={settings.deckCount} onChange={(e) => updateSettings('deckCount', parseInt(e.target.value))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-slate-700 bg-white">
                                {[1, 2, 3].map(n => <option key={n} value={n}>{n} 束</option>)}
                            </select>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.digitsPerImage} (Cards/Img)</label>
                            <select value={settings.cardsPerImage} onChange={(e) => updateSettings('cardsPerImage', parseInt(e.target.value))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-slate-700 bg-white">
                                {[1, 2].map(n => <option key={n} value={n}>{n} 枚</option>)}
                            </select>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.imagesPerView}</label>
                            <select value={settings.imagesPerView} onChange={(e) => updateSettings('imagesPerView', parseInt(e.target.value))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-slate-700 bg-white">
                                {[1, 2, 3, 4, 5].map(n => <option key={n} value={n}>{n} 枚</option>)}
                            </select>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.autoNextSpeed}</label>
                            <select value={settings.autoNext} onChange={(e) => updateSettings('autoNext', parseFloat(e.target.value))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-slate-700 bg-white">
                                <option value={0}>{t.autoNextOff}</option>
                                {[0.5, 1.0, 1.5, 2.0, 3.0, 5.0].map(n => <option key={n} value={n}>{n}s</option>)}
                            </select>
                        </section>
                    </div>
                    <button onClick={onClose} className="w-full mt-8 py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-all">{t.close}</button>
                </div>
            </div>
        );
    };

    const CardTrainer = ({ onBack, globalSettings, t }) => {
        const [gameState, setGameState] = useState('menu');
        const [trainingType, setTrainingType] = useState(null);
        const [deck, setDeck] = useState([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [userRecall, setUserRecall] = useState([]);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [countdownText, setCountdownText] = useState('');
        const [startTime, setStartTime] = useState(0);
        const [endTime, setEndTime] = useState(0);
        const [selectedSuit, setSelectedSuit] = useState(null);

        const [settings, setSettings] = useState(() => {
            const saved = localStorage.getItem('card_settings');
            return saved ? JSON.parse(saved) : { 
                deckCount: 1, cardsPerImage: 2, imagesPerView: 1,
                autoNext: 0
            };
        });

        const updateSettings = (key, val) => {
            const ns = {...settings, [key]: val};
            setSettings(ns);
            localStorage.setItem('card_settings', JSON.stringify(ns));
        };

        const generateDeck = useCallback(() => {
            let d = [];
            for(let i=0; i<settings.deckCount; i++) {
                const tempDeck = [];
                SUITS.forEach(suit => {
                    VALUES.forEach(val => {
                        tempDeck.push({ suit, value: val, id: generateId() });
                    });
                });
                for (let j = tempDeck.length - 1; j > 0; j--) {
                    const k = Math.floor(Math.random() * (j + 1));
                    [tempDeck[j], tempDeck[k]] = [tempDeck[k], tempDeck[j]];
                }
                d = [...d, ...tempDeck];
            }
            return d;
        }, [settings.deckCount]);

        const startTraining = (type) => {
            setTrainingType(type);
            setDeck(generateDeck());
            setCurrentIndex(0);
            setUserRecall([]);
            setSelectedSuit(null);
            
            if (type === 'conversion') {
                setGameState('memorization');
                setStartTime(performance.now());
            } else {
                setGameState('countdown');
                let count = globalSettings.countdownSeconds || 3;
                setCountdownText(count.toString());
                const interval = setInterval(() => {
                    count--;
                    if (count === 0) setCountdownText('START!');
                    else if (count < 0) { 
                        clearInterval(interval); 
                        setGameState('memorization'); 
                        setStartTime(performance.now());
                    }
                    else setCountdownText(count.toString());
                }, 1000);
            }
        };

        const handleNext = () => {
            const step = settings.cardsPerImage * settings.imagesPerView;
            const nextIdx = currentIndex + step;
            if(nextIdx >= deck.length) {
                if(trainingType === 'memory') {
                    setGameState('recall');
                } else {
                    setGameState('menu'); 
                }
            } else {
                setCurrentIndex(nextIdx);
            }
        };
        
        const handlePrev = () => {
            const step = settings.cardsPerImage * settings.imagesPerView;
            setCurrentIndex(Math.max(0, currentIndex - step));
        };

        const handleFirst = () => {
            setCurrentIndex(0);
        };

        useEffect(() => {
            let timer;
            if(gameState === 'memorization' && settings.autoNext > 0) {
                timer = setInterval(() => {
                    handleNext();
                }, settings.autoNext * 1000);
            }
            return () => clearInterval(timer);
        }, [gameState, currentIndex, settings.autoNext]);

        const handleRecallInput = (val) => {
            if(selectedSuit) {
                const card = { suit: selectedSuit, value: val, id: generateId() };
                setUserRecall(prev => [...prev, card]);
                setSelectedSuit(null); 
            }
        };
        
        const handleBackspace = () => {
            setUserRecall(prev => prev.slice(0, -1));
        };

        const finishRecall = () => {
            setEndTime(performance.now());
            setGameState('result');
        };

        const handleHomeClick = () => handleHomeWithConfirm(gameState, onBack, t);

        if (gameState === 'menu') {
            return (
                <div className="h-full flex flex-col p-4 relative overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={onBack} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-rose-600 transition-colors z-50"><i className="fa-solid fa-house"></i></button>
                        <h2 className="text-lg font-bold text-slate-800">{t.card}</h2>
                        <button onClick={() => setIsSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-rose-600 transition-colors"><i className="fa-solid fa-cog"></i></button>
                    </div>
                    <div className="flex-grow flex flex-col items-center justify-center gap-6">
                        <button onClick={() => startTraining('conversion')} className="w-full max-w-sm p-6 bg-white border-2 border-slate-100 rounded-[2rem] shadow-sm active:scale-95 transition-all text-left group hover:border-rose-200">
                            <div className="w-12 h-12 bg-rose-50 rounded-2xl flex items-center justify-center text-rose-500 mb-4 text-2xl group-hover:bg-rose-500 group-hover:text-white transition-colors"><i className="fa-solid fa-shuffle"></i></div>
                            <div className="text-xl font-black text-slate-800 mb-1">{t.numConversion}</div>
                            <div className="text-xs font-bold text-slate-400">{t.descConversion}</div>
                        </button>
                        <button onClick={() => startTraining('memory')} className="w-full max-w-sm p-6 bg-rose-500 text-white rounded-[2rem] shadow-lg active:scale-95 transition-all text-left relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10"></div>
                            <div className="relative z-10">
                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-white mb-4 text-2xl"><i className="fa-solid fa-brain"></i></div>
                                <div className="text-xl font-black mb-1">{t.numMemory}</div>
                                <div className="text-xs font-bold text-rose-100">{t.descMemory}</div>
                            </div>
                        </button>
                    </div>
                    {isSettingsOpen && <CardSettingsModal settings={settings} updateSettings={updateSettings} onClose={() => setIsSettingsOpen(false)} t={t} />}
                </div>
            );
        }

        if (gameState === 'countdown') return <div className="h-full flex items-center justify-center bg-rose-500 text-white"><div className="text-8xl font-black animate-countdown px-4 text-center">{countdownText}</div></div>;

        if (gameState === 'memorization') {
            const step = settings.cardsPerImage * settings.imagesPerView;
            const currentBatch = deck.slice(currentIndex, currentIndex + step);
            const images = [];
            for (let i = 0; i < currentBatch.length; i += settings.cardsPerImage) {
                images.push(currentBatch.slice(i, i + settings.cardsPerImage));
            }

            return (
                <div className="h-full flex flex-col p-6 bg-rose-50">
                    <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-4">
                            <button onClick={handleHomeClick} className="w-8 h-8 flex items-center justify-center bg-white/50 rounded-full text-rose-700 hover:bg-white transition-colors z-50"><i className="fa-solid fa-house text-xs"></i></button>
                            <div className="text-sm font-bold text-rose-600 uppercase tracking-widest">{trainingType === 'conversion' ? t.numConversion : t.memorization}</div>
                            </div>
                            <div className="text-xs font-bold text-slate-400">{currentIndex} / {deck.length}</div>
                    </div>
                    <div className="flex-grow flex flex-col items-center justify-center gap-8">
                        {images.map((imgGroup, idx) => (
                            <div key={idx} className="flex gap-4">
                                {imgGroup.map((c, cIdx) => (
                                    <Card key={c.id} suit={c.suit} value={c.value} className="w-24 h-36 sm:w-32 sm:h-48 text-2xl sm:text-4xl" />
                                ))}
                            </div>
                        ))}
                    </div>
                    
                    {trainingType === 'memory' ? (
                        <MemoryNavControls 
                            onFirst={handleFirst} 
                            onPrev={handlePrev} 
                            onNext={handleNext} 
                            onFinish={() => setGameState('recall')} 
                            current={currentIndex}
                            total={deck.length}
                            t={t}
                        />
                    ) : (
                        <button onClick={handleNext} className="w-full py-6 bg-white text-rose-600 text-xl font-black rounded-[2rem] shadow-xl active:scale-95 transition-all mt-6">
                            {currentIndex + step >= deck.length ? t.finish : t.next}
                        </button>
                    )}
                </div>
            );
        }

        if (gameState === 'recall') {
            return (
                <div className="h-full flex flex-col bg-slate-50">
                    <div className="flex-grow p-4 overflow-hidden flex flex-col">
                            <div className="flex justify-between items-center mb-2">
                                <div className="flex items-center gap-4">
                                    <button onClick={handleHomeClick} className="w-8 h-8 flex items-center justify-center bg-white rounded-full text-slate-500 hover:bg-slate-200 transition-colors z-50"><i className="fa-solid fa-house text-xs"></i></button>
                                    <div className="text-sm font-bold text-slate-400 uppercase tracking-widest">{t.recallInput}</div>
                                </div>
                                <div className="text-xs font-bold text-slate-400">{userRecall.length} / {deck.length}</div>
                            </div>
                            <div className="flex-grow bg-white rounded-2xl border-2 border-slate-200 p-2 overflow-y-auto shadow-inner content-start grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 place-content-start">
                            {userRecall.length === 0 && <span className="text-slate-300 col-span-full text-center py-10">{t.inputPlace}</span>}
                            {userRecall.map((c, i) => (
                                <div key={i} className={`relative rounded border p-1 flex items-center justify-center bg-slate-50 ${c.suit === 'heart' || c.suit === 'diamond' ? 'text-red-500 border-red-100' : 'text-slate-800 border-slate-200'}`}>
                                    <span className="text-xs mr-0.5">{SUIT_ICONS[c.suit]}</span>
                                    <span className="font-bold text-sm">{c.value}</span>
                                </div>
                            ))}
                            </div>
                    </div>
                    <div className="bg-white rounded-t-[2rem] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 pb-8 z-10">
                        <div className="flex justify-between mb-4 px-2">
                            <button onClick={handleBackspace} className="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center shadow-sm active:bg-red-100"><i className="fa-solid fa-delete-left"></i></button>
                            <button onClick={finishRecall} className="px-6 h-12 bg-rose-500 text-white font-bold rounded-full shadow-lg active:scale-95">{t.checkResult}</button>
                        </div>
                        <div className="grid grid-cols-4 gap-3 mb-4">
                            {SUITS.map(s => (
                                <button key={s} onClick={() => setSelectedSuit(selectedSuit === s ? null : s)} className={`h-14 rounded-2xl text-2xl flex items-center justify-center transition-all ${selectedSuit === s ? 'bg-slate-800 text-white shadow-md scale-105' : 'bg-slate-100 text-slate-400'}`}>
                                    <span className={selectedSuit !== s && (s === 'heart' || s === 'diamond') ? 'text-red-400' : ''}>{SUIT_ICONS[s]}</span>
                                </button>
                            ))}
                        </div>
                        <div className="grid grid-cols-7 gap-1.5 sm:gap-2">
                            {VALUES.map(v => (
                                <button key={v} onClick={() => handleRecallInput(v)} disabled={!selectedSuit} className={`aspect-square rounded-xl font-bold text-lg flex items-center justify-center transition-all ${!selectedSuit ? 'bg-slate-50 text-slate-200 cursor-not-allowed' : 'bg-white border border-slate-200 text-slate-700 shadow-sm active:scale-90 active:bg-slate-100'}`}>
                                    {v}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        if (gameState === 'result') {
                const fullDeck = deck; 
                let correct = 0;
                for(let i=0; i<Math.min(fullDeck.length, userRecall.length); i++) {
                    if(fullDeck[i].suit === userRecall[i].suit && fullDeck[i].value === userRecall[i].value) { correct++; }
                }
                const time = endTime - startTime;
                return (
                <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6 pt-2">
                        <h2 className="text-2xl font-black text-slate-800"><i className="fa-solid fa-square-check text-rose-500 mr-2"></i> {t.result}</h2>
                        <button onClick={() => setGameState('menu')} className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-500"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <div className="bg-white rounded-[2rem] p-6 shadow-xl mb-6 border border-slate-100">
                            <div className="grid grid-cols-2 gap-4 text-center">
                                <div><div className="text-xs font-bold text-slate-400 uppercase tracking-widest">{t.correctRate}</div><div className="text-3xl font-black text-slate-800">{correct} <span className="text-lg text-slate-400">/ {fullDeck.length}</span></div></div>
                                <div><div className="text-xs font-bold text-slate-400 uppercase tracking-widest">{t.rawTime}</div><div className="text-3xl font-black text-slate-800">{formatTime(time)}</div></div>
                            </div>
                    </div>
                    <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 mb-6 flex-grow overflow-y-auto">
                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">DETAILS</h3>
                        <div className="grid grid-cols-1 gap-2">
                            {fullDeck.map((card, i) => {
                                const userCard = userRecall[i];
                                const isCorrect = userCard && userCard.suit === card.suit && userCard.value === card.value;
                                return (
                                    <div key={i} className="flex items-center justify-between p-2 border-b border-slate-50 last:border-0">
                                        <span className="text-xs text-slate-300 font-mono w-6">{i+1}</span>
                                        <div className="flex items-center gap-4">
                                            <div className="flex items-center gap-1 w-12 justify-end"><span className={`text-sm ${card.suit === 'heart' || card.suit === 'diamond' ? 'text-red-500' : 'text-slate-700'}`}>{SUIT_ICONS[card.suit]} {card.value}</span></div>
                                            <i className={`fa-solid fa-arrow-right text-xs text-slate-200`}></i>
                                            <div className="flex items-center gap-1 w-12">{userCard ? (<span className={`text-sm font-bold ${userCard.suit === 'heart' || userCard.suit === 'diamond' ? 'text-red-500' : 'text-slate-700'}`}>{SUIT_ICONS[userCard.suit]} {userCard.value}</span>) : (<span className="text-slate-300 text-xs">-</span>)}</div>
                                        </div>
                                        <div className="w-6 text-right">{isCorrect ? <i className="fa-solid fa-check text-green-500"></i> : <i className="fa-solid fa-xmark text-red-400"></i>}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <button onClick={() => startTraining('memory')} className="w-full py-6 bg-rose-500 text-white text-xl font-black rounded-[2rem] shadow-lg active:scale-95 transition-all mb-4"><i className="fa-solid fa-rotate-right mr-2"></i> {t.retry}</button>
                </div>
            );
        }
        return null;
    };

    const NumberSettingsModal = ({ settings, updateSettings, onClose, t }) => {
        return (
            <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-y-auto max-h-[85vh] no-scrollbar">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-lg font-bold flex items-center gap-2 text-slate-800"><i className="fa-solid fa-cog text-emerald-500"></i> {t.gameSettings}</h3>
                        <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <div className="space-y-5">
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.digitsPerGroup}</label>
                            <select value={settings.digitsPerGroup} onChange={(e) => updateSettings('digitsPerGroup', parseInt(e.target.value))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-slate-700 bg-white">
                                {[1, 2, 3, 4].map(n => <option key={n} value={n}>{n}</option>)}
                            </select>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.totalDigitsNum}</label>
                            <input type="number" min="1" max="1000" value={settings.totalDigits} onChange={(e) => updateSettings('totalDigits', Math.max(1, parseInt(e.target.value)||80))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-center text-slate-700 bg-white" />
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.autoNextSpeed}</label>
                            <select value={settings.autoNext} onChange={(e) => updateSettings('autoNext', parseFloat(e.target.value))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-slate-700 bg-white">
                                <option value={0}>{t.autoNextOff}</option>
                                {[0.5, 1.0, 1.5, 2.0, 3.0, 5.0].map(n => <option key={n} value={n}>{n}s</option>)}
                            </select>
                        </section>
                    </div>
                    <button onClick={onClose} className="w-full mt-8 py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-all">{t.close}</button>
                </div>
            </div>
        );
    };

    const NumberTrainer = ({ onBack, globalSettings, t }) => {
        const [gameState, setGameState] = useState('menu');
        const [trainingType, setTrainingType] = useState(null);
        const [sequence, setSequence] = useState([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [userInput, setUserInput] = useState("");
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [countdownText, setCountdownText] = useState('');
        const [startTime, setStartTime] = useState(0);
        const [endTime, setEndTime] = useState(0);
        const [endlessNumber, setEndlessNumber] = useState('');
        const [isNewRecord, setIsNewRecord] = useState(false);
        const [resultData, setResultData] = useState(null);

        const [settings, setSettings] = useState(() => {
            const saved = localStorage.getItem('number_settings_v3');
            return saved ? JSON.parse(saved) : { digitsPerGroup: 2, totalDigits: 80, autoNext: 0 };
        });

        const updateSettings = (key, val) => { const ns = {...settings, [key]: val}; setSettings(ns); localStorage.setItem('number_settings_v3', JSON.stringify(ns)); };
        
        const generateSequence = useCallback(() => {
            const total = settings.totalDigits;
            const seq = [];
            for(let i=0; i<total; i++) {
                    seq.push(Math.floor(Math.random() * 10).toString());
            }
            return seq;
        }, [settings]);

        const generateEndlessNumber = useCallback(() => {
            let num = "";
            for(let i=0; i<settings.digitsPerGroup; i++) num += Math.floor(Math.random() * 10).toString();
            return num;
        }, [settings.digitsPerGroup]);

        const startTraining = (type) => {
            setTrainingType(type);
            if (type === 'memory') {
                const rawSeq = generateSequence();
                const chunked = [];
                for(let i=0; i<rawSeq.length; i+=settings.digitsPerGroup) {
                        chunked.push(rawSeq.slice(i, i+settings.digitsPerGroup).join(''));
                }
                setSequence(chunked);
                setCurrentIndex(0);
                setUserInput("");
                setResultData(null);
                
                setGameState('countdown');
                let count = globalSettings.countdownSeconds || 3;
                setCountdownText(count.toString());
                const interval = setInterval(() => {
                    count--;
                    if (count === 0) setCountdownText('START!');
                    else if (count < 0) { 
                        clearInterval(interval);
                        setGameState('memorization');
                        setStartTime(performance.now());
                    } else setCountdownText(count.toString());
                }, 1000);
            } else {
                setEndlessNumber(generateEndlessNumber());
                setGameState('conversion');
            }
        };

        const handleNext = () => {
            if(trainingType === 'memory') {
                    if(currentIndex + 1 >= sequence.length) {
                    setGameState('recall');
                    } else {
                    setCurrentIndex(prev => prev + 1);
                    }
            } else {
                setEndlessNumber(generateEndlessNumber());
            }
        };
        
        const handlePrev = () => {
            setCurrentIndex(Math.max(0, currentIndex - 1));
        };

        const handleFirst = () => {
            setCurrentIndex(0);
        };

        useEffect(() => {
            let timer;
            if((gameState === 'memorization' || gameState === 'conversion') && settings.autoNext > 0) {
                timer = setInterval(() => {
                    handleNext();
                }, settings.autoNext * 1000);
            }
            return () => clearInterval(timer);
        }, [gameState, currentIndex, settings.autoNext, endlessNumber]);

        const handleRecallInput = (num) => { setUserInput(prev => prev + num); };
        const handleBackspace = () => { setUserInput(prev => prev.slice(0, -1)); };
        
        const finishRecall = () => {
            const now = performance.now();
            setEndTime(now);
            
            const time = now - startTime;
            const rawSeq = sequence.join('');
            let mistakes = 0;
            const len = Math.max(rawSeq.length, userInput.length);
            for(let i=0; i<len; i++) {
                if (rawSeq[i] !== userInput[i]) mistakes++;
            }
            const penaltySeconds = mistakes * 5;
            const finalScore = time + (penaltySeconds * 1000);
            const correctCount = len - mistakes;
            
            const records = JSON.parse(localStorage.getItem('number_records') || '[]');
            const best = records.length > 0 ? Math.min(...records.map(r => r.finalScore)) : null;
            const isNew = best === null || finalScore < best;

            if(isNew) {
                 confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                 setIsNewRecord(true);
            } else {
                 setIsNewRecord(false);
            }

            const newRecord = {
                timestamp: Date.now(),
                totalDigits: settings.totalDigits,
                time,
                penaltySeconds,
                finalScore,
                accuracy: correctCount
            };
            localStorage.setItem('number_records', JSON.stringify([...records, newRecord].slice(-100)));
            
            setResultData({
                time, penaltySeconds, finalScore, correctCount, rawSeq, userInput
            });
            setGameState('result');
        };

        const handleHomeClick = () => handleHomeWithConfirm(gameState, onBack, t);

        if (gameState === 'menu') return (
            <div className="h-full flex flex-col p-4 relative overflow-y-auto no-scrollbar">
                <div className="flex justify-between items-center mb-6"><button onClick={onBack} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-emerald-600 transition-colors z-50"><i className="fa-solid fa-house"></i></button><h2 className="text-lg font-bold text-slate-800">{t.number}</h2><button onClick={() => setIsSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-emerald-600 transition-colors"><i className="fa-solid fa-cog"></i></button></div>
                <div className="flex-grow flex flex-col items-center justify-center gap-6">
                    <button onClick={() => startTraining('conversion')} className="w-full max-w-sm p-6 bg-white border-2 border-slate-100 rounded-[2rem] shadow-sm active:scale-95 transition-all text-left group hover:border-emerald-200"><div className="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-500 mb-4 text-2xl group-hover:bg-emerald-500 group-hover:text-white transition-colors"><i className="fa-solid fa-shuffle"></i></div><div className="text-xl font-black text-slate-800 mb-1">{t.numConversion}</div><div className="text-xs font-bold text-slate-400">{t.descConversion}</div></button>
                    <button onClick={() => startTraining('memory')} className="w-full max-w-sm p-6 bg-emerald-600 text-white rounded-[2rem] shadow-lg active:scale-95 transition-all text-left relative overflow-hidden"><div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10"></div><div className="relative z-10"><div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-white mb-4 text-2xl"><i className="fa-solid fa-brain"></i></div><div className="text-xl font-black mb-1">{t.numMemory}</div><div className="text-xs font-bold text-emerald-100">{t.descMemory}</div></div></button>
                </div>
                {isSettingsOpen && <NumberSettingsModal settings={settings} updateSettings={updateSettings} onClose={() => setIsSettingsOpen(false)} t={t} />}
            </div>
        );

        if (gameState === 'countdown') return <div className="h-full flex items-center justify-center bg-emerald-600 text-white"><div className="text-8xl font-black animate-countdown px-4 text-center">{countdownText}</div></div>;

        if (gameState === 'conversion') {
                return (
                <div className="h-full flex flex-col p-6 bg-emerald-50">
                    <div className="flex justify-between items-center mb-10">
                        <div className="flex items-center gap-4">
                            <button onClick={handleHomeClick} className="w-8 h-8 flex items-center justify-center bg-white/50 rounded-full text-emerald-700 hover:bg-white transition-colors z-50"><i className="fa-solid fa-house text-xs"></i></button>
                            <div className="text-sm font-bold text-emerald-600 uppercase tracking-widest">{t.numConversion}</div>
                        </div>
                        <div className="text-xs font-bold text-slate-400">{t.endless}</div>
                    </div>
                    <div className="flex-grow flex flex-col items-center justify-center"><div className="text-7xl sm:text-9xl font-mono font-black text-emerald-800 text-center tracking-tight">{endlessNumber}</div></div>
                    <div className="grid grid-cols-2 gap-4 mt-auto">
                        <button onClick={() => setGameState('menu')} className="w-full py-6 bg-white text-slate-400 font-black rounded-[2rem] shadow-sm active:scale-95 transition-all">{t.finish}</button>
                        <button onClick={handleNext} className="w-full py-6 bg-emerald-600 text-white font-black rounded-[2rem] shadow-lg active:scale-95 transition-all">{t.next}</button>
                    </div>
                </div>
            );
        }

        if (gameState === 'memorization') {
            return (
                <div className="h-full flex flex-col p-6 bg-emerald-50">
                    <div className="flex justify-between items-center mb-10">
                        <div className="flex items-center gap-4">
                            <button onClick={handleHomeClick} className="w-8 h-8 flex items-center justify-center bg-white/50 rounded-full text-emerald-700 hover:bg-white transition-colors z-50"><i className="fa-solid fa-house text-xs"></i></button>
                            <div className="text-sm font-bold text-emerald-600 uppercase tracking-widest">{t.memorization}</div>
                        </div>
                        <div className="text-xs font-bold text-slate-400">{currentIndex + 1} / {sequence.length}</div>
                    </div>
                    <div className="flex-grow flex flex-col items-center justify-center"><div className="text-7xl sm:text-9xl font-mono font-black text-emerald-800 text-center tracking-tight">{sequence[currentIndex]}</div></div>
                    
                    <MemoryNavControls 
                        onFirst={handleFirst} 
                        onPrev={handlePrev} 
                        onNext={handleNext} 
                        onFinish={() => setGameState('recall')} 
                        current={currentIndex}
                        total={sequence.length}
                        t={t}
                    />
                </div>
            );
        }

        if (gameState === 'recall') {
            const formattedInput = userInput.replace(new RegExp(`.{1,${settings.digitsPerGroup}}`, 'g'), '$& ').trim();
            return (
                <div className="h-full flex flex-col p-4 bg-slate-50">
                        <div className="mb-4 flex-grow flex flex-col">
                        <div className="flex justify-between items-center mb-2 flex-none">
                            <div className="flex items-center gap-4">
                                <button onClick={handleHomeClick} className="w-8 h-8 flex items-center justify-center bg-white rounded-full text-slate-500 hover:bg-slate-200 transition-colors z-50"><i className="fa-solid fa-house text-xs"></i></button>
                                <div className="text-sm font-bold text-slate-400 uppercase tracking-widest">{t.recallInput}</div>
                            </div>
                            <div className="text-xs font-bold text-slate-400">{userInput.length} / {settings.totalDigits}</div>
                        </div>
                        <div className="flex-grow w-full bg-white rounded-2xl border-2 border-slate-200 p-6 font-mono text-3xl sm:text-4xl font-bold text-slate-800 overflow-y-auto break-all tracking-widest shadow-inner leading-relaxed">
                            {formattedInput || <span className="text-slate-300 tracking-normal font-sans text-lg">{t.inputPlace}</span>}
                        </div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 mb-4 h-64 flex-none">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => <button key={n} onClick={() => handleRecallInput(n.toString())} className="bg-white rounded-xl shadow-sm border-b-4 border-slate-100 active:border-b-0 active:translate-y-1 transition-all text-2xl font-bold text-slate-700 flex items-center justify-center">{n}</button>)}
                        <button onClick={handleBackspace} className="bg-red-50 text-red-500 rounded-xl shadow-sm border-b-4 border-red-100 active:border-b-0 active:translate-y-1 transition-all text-xl font-bold flex items-center justify-center"><i className="fa-solid fa-delete-left"></i></button>
                        <button onClick={() => handleRecallInput('0')} className="bg-white rounded-xl shadow-sm border-b-4 border-slate-100 active:border-b-0 active:translate-y-1 transition-all text-2xl font-bold text-slate-700 flex items-center justify-center">0</button>
                        <button onClick={finishRecall} className="bg-emerald-600 text-white rounded-xl shadow-lg border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1 transition-all text-xl font-bold flex items-center justify-center">{t.checkResult}</button>
                    </div>
                </div>
            );
        }

        if (gameState === 'result' && resultData) {
            const { time, penaltySeconds, finalScore, correctCount, rawSeq, userInput } = resultData;
            const records = JSON.parse(localStorage.getItem('number_records') || '[]');
            const best = records.length > 0 ? Math.min(...records.map(r => r.finalScore)) : null;

            return (
                <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6 pt-2">
                        <div><h2 className="text-2xl font-black text-slate-800 flex items-center gap-2"><i className="fa-solid fa-award text-emerald-500"></i> {t.result}</h2></div>
                        <div className="flex gap-2"><button onClick={handleHomeClick} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm transition-all hover:text-emerald-600 z-50"><i className="fa-solid fa-house"></i></button></div>
                    </div>
                    
                        <div className="w-full bg-emerald-600 text-white rounded-[2.5rem] p-8 sm:p-10 mb-8 shadow-2xl relative flex flex-col items-center text-center">
                        {isNewRecord && (<div className="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-[10px] font-black px-4 py-1.5 rounded-bl-2xl uppercase tracking-widest shadow-md">{t.newRecord}</div>)}
                        <div className="text-[11px] font-black opacity-60 uppercase tracking-widest mb-1">{t.finalScore}</div>
                        <div className="text-6xl sm:text-7xl font-mono font-black mb-4 tracking-tighter drop-shadow-lg truncate w-full">{formatTime(finalScore)}</div>
                        <div className="flex items-center gap-2 mb-10 bg-black/10 px-5 py-2 rounded-full"><i className="fa-solid fa-crown text-yellow-400 text-xs"></i><span className="text-sm font-black tracking-widest uppercase">{t.bestScore}: {best ? formatTime(Math.min(best, finalScore)) : formatTime(finalScore)}</span></div>
                        
                        <div className="w-full space-y-8 pt-8 border-t border-white/20">
                            <div className="grid grid-cols-2 w-full gap-4">
                                <div className="flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.rawTime}</div><div className="font-mono font-black text-2xl">{formatTime(time)}</div></div>
                                <div className="flex flex-col items-center"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.accuracy}</div><div className="font-mono font-black text-2xl tracking-tight">{correctCount} / {rawSeq.length}</div></div>
                            </div>
                            <div className="grid grid-cols-2 w-full gap-4">
                                <div className="flex flex-col items-center col-span-2"><div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.penalty}</div><div className={`font-mono font-black text-2xl tracking-tight ${penaltySeconds > 0 ? 'text-red-300' : 'text-green-300'}`}>+{penaltySeconds}s <span className="text-[10px] opacity-70">({t.fiveSecPenalty})</span></div></div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 mb-6 flex-grow overflow-y-auto">
                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">DETAILS</h3>
                        <div className="font-mono text-lg break-all tracking-widest leading-loose">
                            {rawSeq.split('').map((char, i) => { 
                                const userChar = userInput[i]; 
                                let color = 'text-slate-300'; 
                                if (userChar === char) color = 'text-emerald-600 font-bold'; 
                                else if (userChar) color = 'text-red-500 font-bold bg-red-50'; 
                                return <span key={i} className={color}>{char}</span>; 
                            })}
                        </div>
                    </div>
                    <button onClick={() => startTraining('memory')} className="w-full py-6 bg-emerald-600 text-white text-xl font-black rounded-[2rem] shadow-lg active:scale-95 transition-all mb-4"><i className="fa-solid fa-rotate-right mr-2"></i> {t.retry}</button>
                </div>
            );
        }
        return null;
    };

    const LetterPairSettingsModal = ({ settings, updateSettings, onClose, t }) => {
        return (
            <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-y-auto max-h-[85vh] no-scrollbar">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-lg font-bold flex items-center gap-2 text-slate-800"><i className="fa-solid fa-cog text-amber-500"></i> {t.gameSettings}</h3>
                        <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <div className="space-y-5">
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.rowSelect}</label>
                            <div className="grid grid-cols-3 gap-2">
                                {KANA_ROWS.map(r => (
                                    <button key={r} onClick={() => updateSettings('activeRows', settings.activeRows.includes(r) ? settings.activeRows.filter(x => x!==r) : [...settings.activeRows, r])} className={`py-2 rounded-xl border-2 font-bold text-sm transition-all ${settings.activeRows.includes(r) ? 'bg-amber-50 border-amber-600 text-amber-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>{r}行</button>
                                ))}
                            </div>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.qCount}</label>
                            <input type="number" min="1" max="100" value={settings.qCount} onChange={e=>updateSettings('qCount', Math.max(1, Math.min(100, parseInt(e.target.value)||10)))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-center text-slate-700 bg-white" />
                        </section>
                        <section>
                            <label className="flex items-center gap-3 p-3 border-2 border-slate-100 rounded-xl cursor-pointer hover:bg-slate-50">
                                <input type="checkbox" checked={settings.alwaysShowAnswer} onChange={(e) => updateSettings('alwaysShowAnswer', e.target.checked)} className="w-5 h-5 accent-amber-500" />
                                <span className="font-bold text-sm text-slate-700">{t.alwaysShow}</span>
                            </label>
                        </section>
                        <section>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.autoNextSpeed}</label>
                            <select value={settings.autoNext} onChange={(e) => updateSettings('autoNext', parseFloat(e.target.value))} className="w-full p-2.5 border-2 border-slate-100 rounded-xl font-bold text-slate-700 bg-white">
                                <option value={0}>{t.autoNextOff}</option>
                                {[0.5, 1.0, 1.5, 2.0, 3.0, 5.0].map(n => <option key={n} value={n}>{n}s</option>)}
                            </select>
                        </section>
                    </div>
                    <button onClick={onClose} className="w-full mt-8 py-4 bg-slate-900 text-white font-bold rounded-2xl active:scale-95 transition-all">{t.close}</button>
                </div>
            </div>
        );
    };

    const LetterPairTrainer = ({ onBack, globalSettings, t }) => {
        const [gameState, setGameState] = useState('menu');
        const [trainingType, setTrainingType] = useState(null);
        const [questions, setQuestions] = useState([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [userAnswers, setUserAnswers] = useState([]);
        const [input, setInput] = useState("");
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [isAnswerShown, setIsAnswerShown] = useState(false);
        const [countdownText, setCountdownText] = useState('');
        const [startTime, setStartTime] = useState(0);
        const [endTime, setEndTime] = useState(0);
        
        const [settings, setSettings] = useState(() => {
            const saved = localStorage.getItem('letter_settings_v7');
            return saved ? JSON.parse(saved) : { activeRows: ['あ', 'か', 'さ', 'た', 'な', 'は'], qCount: 10, autoNext: 0, alwaysShowAnswer: false };
        });

        const [masterData, setMasterData] = useState(() => {
            const saved = localStorage.getItem('letter_master_custom_v6');
            if (saved) {
                const parsed = JSON.parse(saved);
                return { ...DEFAULT_LETTER_MASTER, ...parsed };
            }
            return DEFAULT_LETTER_MASTER;
        });

        const updateSettings = (key, val) => {
            const ns = {...settings, [key]: val};
            setSettings(ns);
            localStorage.setItem('letter_settings_v7', JSON.stringify(ns));
        };

        const generateQuestions = useCallback(() => {
            const pool = [];
            settings.activeRows.forEach(row => {
                const data = masterData[row];
                if (data) Object.keys(data).forEach(pair => pool.push({ pair, answer: data[pair], row }));
            });
            if (pool.length === 0) return [];
            const shuffled = [...pool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, settings.qCount);
        }, [settings, masterData]);

        const startTraining = (type) => {
            const qs = generateQuestions();
            if (qs.length === 0) { alert('選択された行にデータがありません'); return; }
            setTrainingType(type);
            setQuestions(qs);
            setCurrentIndex(0);
            setUserAnswers([]);
            setInput("");
            setIsAnswerShown(type === 'conversion' ? settings.alwaysShowAnswer : false);
            
            if (type === 'conversion') {
                setGameState('training'); 
                setStartTime(performance.now());
            } else {
                setGameState('countdown');
                let count = globalSettings.countdownSeconds || 3;
                setCountdownText(count.toString());
                const interval = setInterval(() => {
                    count--;
                    if (count === 0) setCountdownText('START!');
                    else if (count < 0) { 
                        clearInterval(interval); 
                        setGameState('training'); 
                        setStartTime(performance.now());
                    } else setCountdownText(count.toString());
                }, 1000);
            }
        };

        const handleNext = () => {
            if (currentIndex + 1 >= questions.length) {
                setEndTime(performance.now());
                setGameState(trainingType === 'memory' ? 'result' : 'menu');
            } else {
                setCurrentIndex(prev => prev + 1);
                setInput("");
                setIsAnswerShown(trainingType === 'conversion' ? settings.alwaysShowAnswer : false);
            }
        };
        
        const handleMemoryInput = () => {
            const ans = [...userAnswers];
            ans[currentIndex] = input;
            setUserAnswers(ans);
            handleNext();
        };

        useEffect(() => {
            let timer;
            if (gameState === 'training' && settings.autoNext > 0 && trainingType === 'conversion') {
                if (!isAnswerShown) {
                     timer = setTimeout(() => setIsAnswerShown(true), settings.autoNext * 1000);
                } else {
                     timer = setTimeout(() => handleNext(), settings.autoNext * 1000);
                }
            }
            return () => clearTimeout(timer);
        }, [gameState, currentIndex, isAnswerShown, settings.autoNext, trainingType]);

        const handleEditAnswer = () => {
            const q = questions[currentIndex];
            const newAns = prompt(`${q.pair} のイメージを編集:`, q.answer);
            if(newAns !== null && newAns.trim() !== "") {
                const updatedMaster = { ...masterData, [q.row]: { ...masterData[q.row], [q.pair]: newAns.trim() } };
                setMasterData(updatedMaster);
                localStorage.setItem('letter_master_custom_v6', JSON.stringify(updatedMaster));
                const newQs = [...questions];
                newQs[currentIndex].answer = newAns.trim();
                setQuestions(newQs);
            }
        };
        
        const handleHomeClick = () => handleHomeWithConfirm(gameState, onBack, t);

        if (gameState === 'menu') return (
            <div className="h-full flex flex-col p-6 items-center justify-center gap-6 relative">
                <button onClick={onBack} className="absolute top-6 left-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm z-50"><i className="fa-solid fa-house"></i></button>
                <h2 className="absolute top-8 text-lg font-bold text-slate-800">{t.letterPair}</h2>
                <button onClick={() => setIsSettingsOpen(true)} className="absolute top-6 right-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-400 hover:text-amber-500"><i className="fa-solid fa-cog"></i></button>
                
                <button onClick={() => startTraining('conversion')} className="w-full max-w-sm p-6 bg-white border-2 border-slate-100 rounded-[2rem] shadow-sm active:scale-95 text-left group hover:border-amber-200 transition-all">
                    <div className="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center text-amber-500 mb-4 text-2xl group-hover:bg-amber-500 group-hover:text-white transition-colors"><i className="fa-solid fa-shuffle"></i></div>
                    <div className="text-xl font-black text-slate-800 mb-1">{t.numConversion}</div>
                    <div className="text-xs font-bold text-slate-400">{t.descConversion}</div>
                </button>
                
                 <button onClick={() => startTraining('memory')} className="w-full max-w-sm p-6 bg-amber-600 text-white rounded-[2rem] shadow-lg active:scale-95 text-left transition-all">
                    <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-white mb-4 text-2xl"><i className="fa-solid fa-brain"></i></div>
                    <div className="text-xl font-black mb-1">{t.numMemory}</div>
                    <div className="text-xs font-bold text-amber-100">{t.descMemory}</div>
                </button>
                
                {isSettingsOpen && <LetterPairSettingsModal settings={settings} updateSettings={updateSettings} onClose={() => setIsSettingsOpen(false)} t={t} />}
            </div>
        );

        if (gameState === 'countdown') return <div className="h-full flex items-center justify-center bg-amber-500 text-white"><div className="text-8xl font-black animate-countdown px-4 text-center">{countdownText}</div></div>;

        if (gameState === 'training') {
            const q = questions[currentIndex];
            return (
                <div className="h-full flex flex-col p-6 bg-amber-50">
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-4">
                            <button onClick={handleHomeClick} className="w-8 h-8 flex items-center justify-center bg-white/50 rounded-full text-amber-700 hover:bg-white transition-colors z-50"><i className="fa-solid fa-house text-xs"></i></button>
                            <span className="font-black text-amber-700 uppercase tracking-widest text-sm">{trainingType === 'memory' ? t.numMemory : t.numConversion}</span>
                        </div>
                        <span className="font-black text-amber-700 uppercase tracking-widest">{currentIndex + 1} / {questions.length}</span>
                    </div>
                    
                    <div className="flex-grow flex flex-col items-center justify-center">
                        <div className="text-8xl font-black text-amber-800 mb-10">{q.pair}</div>
                        
                        {trainingType === 'conversion' && (
                            <div className="h-32 flex items-center justify-center w-full">
                                {isAnswerShown ? (
                                    <div className="flex flex-col items-center animate-in fade-in slide-in-from-bottom-4 duration-300">
                                        <div className="text-5xl font-black text-slate-600 mb-4 text-center">{q.answer}</div>
                                        <button onClick={handleEditAnswer} className="text-slate-300 hover:text-amber-500 transition-colors text-sm font-bold flex items-center gap-2 px-4 py-2 bg-white rounded-full shadow-sm"><i className="fa-solid fa-pen"></i> {t.edit}</button>
                                    </div>
                                ) : (
                                    <button onClick={() => setIsAnswerShown(true)} className="px-8 py-4 bg-white/60 text-slate-400 font-bold rounded-2xl border-2 border-slate-200 hover:bg-white hover:text-amber-500 hover:border-amber-200 transition-all">{t.showAnswer || '答えを表示'}</button>
                                )}
                            </div>
                        )}

                        {trainingType === 'memory' && (
                            <div className="w-full max-w-sm">
                                <input 
                                    type="text" 
                                    value={input} 
                                    autoFocus 
                                    onChange={e => setInput(e.target.value)} 
                                    onKeyDown={e => e.key === 'Enter' && handleMemoryInput()}
                                    className="w-full p-6 text-center text-3xl font-bold border-4 border-amber-200 rounded-3xl outline-none focus:border-amber-500 bg-white shadow-lg" 
                                    placeholder={t.wordPlaceholder}
                                />
                            </div>
                        )}
                    </div>
                    
                    <button onClick={trainingType === 'memory' ? handleMemoryInput : handleNext} className="w-full py-8 bg-white text-amber-600 text-2xl font-black rounded-[2rem] shadow-xl active:scale-95 transition-all">
                        {currentIndex + 1 >= questions.length ? t.finish : t.next}
                    </button>
                </div>
            );
        }

        if (gameState === 'result') {
            const correctCount = userAnswers.filter((ans, i) => ans === questions[i].answer).length;
            return (
                <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6 pt-2">
                        <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2"><i className="fa-solid fa-square-check text-amber-500"></i> {t.result}</h2>
                        <button onClick={() => setGameState('menu')} className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-500"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <div className="bg-amber-50 rounded-[2rem] p-8 w-full mb-6 flex justify-between items-center border border-amber-100 shadow-sm">
                        <div><div className="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-1">{t.accuracy}</div><div className="text-4xl font-black text-slate-800">{correctCount} <span className="text-lg text-slate-400">/ {questions.length}</span></div></div>
                        <div><div className="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-1">{t.rawTime}</div><div className="text-4xl font-black text-slate-800">{formatTime(endTime - startTime)}</div></div>
                    </div>
                    <div className="space-y-2 mb-10 flex-grow overflow-y-auto">
                        {questions.map((q, i) => {
                            const isCorrect = userAnswers[i] === q.answer;
                            return (
                                <div key={i} className={`p-4 rounded-xl border flex justify-between items-center ${isCorrect ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                                    <div>
                                        <div className="font-black text-lg text-slate-700">{q.pair} <i className="fa-solid fa-arrow-right text-xs text-slate-300 mx-2"></i> {q.answer}</div>
                                        <div className={`text-sm font-bold ${isCorrect ? 'text-green-600' : 'text-red-500'}`}>{isCorrect ? 'Correct' : `Your Ans: ${userAnswers[i] || '(空欄)'}`}</div>
                                    </div>
                                    {isCorrect ? <i className="fa-solid fa-check text-green-500"></i> : <i className="fa-solid fa-xmark text-red-500"></i>}
                                </div>
                            );
                        })}
                    </div>
                    <button onClick={() => startTraining('memory')} className="w-full py-6 bg-slate-900 text-white font-black rounded-[2rem] shadow-lg mb-10 active:scale-95">{t.retry}</button>
                </div>
            );
        }
        return null;
    };

    const HomeView = ({ onSelectMode, onOpenSettings, t }) => {
        const modes = [
            { id: 'calendar', label: t.calendar, icon: 'fa-calendar-days', color: 'bg-indigo-500', desc: t.descCal },
            { id: 'number', label: t.number, icon: 'fa-hashtag', color: 'bg-emerald-500', desc: t.descNum },
            { id: 'card', label: t.card, icon: 'fa-diamond', color: 'bg-rose-500', desc: t.descCard },
            { id: 'letterpair', label: t.letterPair, icon: 'fa-font', color: 'bg-amber-500', desc: t.descLP }
        ];
        return (
            <div className="h-full flex flex-col p-6 overflow-y-auto no-scrollbar">
                <div className="flex items-center justify-between mb-12 pt-2">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><i className="fa-solid fa-brain text-xl"></i></div>
                        <div>
                            <h1 className="text-xl font-black tracking-tight text-slate-800">{t.appTitle}</h1>
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-tight">{t.trainingType}</p>
                        </div>
                    </div>
                    <button onClick={onOpenSettings} className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-slate-400 hover:text-indigo-600 shadow-sm border border-slate-100 transition-all"><i className="fa-solid fa-gear"></i></button>
                </div>
                <div className="space-y-5">
                    {modes.map(m => (
                        <button key={m.id} onClick={() => onSelectMode(m.id)} className="w-full bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm active:scale-95 transition-all flex items-center text-left hover:shadow-md">
                            <div className={`w-14 h-14 ${m.color} rounded-2xl flex items-center justify-center text-white shadow-md mr-5`}><i className={`fa-solid ${m.icon} text-xl`}></i></div>
                            <div className="flex-grow">
                                <div className="font-black text-lg mb-0.5 text-slate-800">{m.label}</div>
                                <div className="text-xs text-slate-400 font-bold tracking-tight">{m.desc}</div>
                            </div>
                            <i className="fa-solid fa-chevron-right text-slate-300 ml-2"></i>
                        </button>
                    ))}
                </div>
            </div>
        );
    };

    const App = () => {
        const [mode, setMode] = useState('home');
        const [isGlobalSettingsOpen, setIsGlobalSettingsOpen] = useState(false);
        const [globalSettings, setGlobalSettings] = useState(() => {
            try {
                const saved = localStorage.getItem('global_settings');
                return saved ? JSON.parse(saved) : { lang: 'ja', theme: 'light', countdownSeconds: 3 };
            } catch(e) {
                return { lang: 'ja', theme: 'light', countdownSeconds: 3 };
            }
        });
        useEffect(() => { localStorage.setItem('global_settings', JSON.stringify(globalSettings)); }, [globalSettings]);
        const t = translations[globalSettings.lang] || translations.ja;

        return (
            <main className="w-full h-full flex flex-col relative overflow-hidden bg-slate-50">
                {mode === 'home' && (<HomeView t={t} onSelectMode={setMode} onOpenSettings={() => setIsGlobalSettingsOpen(true)} />)}
                {mode === 'calendar' && <CalendarTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                {mode === 'number' && <NumberTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                {mode === 'card' && <CardTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                {mode === 'letterpair' && <LetterPairTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                {isGlobalSettingsOpen && (<GlobalSettingsModal globalSettings={globalSettings} setGlobalSettings={setGlobalSettings} onClose={() => setIsGlobalSettingsOpen(false)} t={t} />)}
            </main>
        );
    };
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>