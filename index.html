<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>メモリープロ - 記憶術マスター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overscroll-behavior-y: contain;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #root { height: 100%; width: 100%; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes countdown-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-countdown { animation: countdown-pulse 1s ease-in-out infinite; }
        
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }

        .question-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .question-blur {
            filter: blur(8px);
            opacity: 0.3;
            pointer-events: none;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import confetti from 'https://esm.sh/canvas-confetti@1.6.0';

        // --- Constants & Utilities ---
        const DAYS_JP = ['日', '月', '火', '水', '木', '金', '土'];
        const DAYS_JP_LONG = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];
        const DAYS_EN = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const DAYS_EN_LONG = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const HIRAGANA_SET = 'あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへ'.split('');

        const getJapaneseEra = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const fullDate = year * 10000 + month * 100 + day;
            if (fullDate >= 20190501) return `令和${year - 2018 === 1 ? '元' : year - 2018}年`;
            if (fullDate >= 19890108) return `平成${year - 1988 === 1 ? '元' : year - 1988}年`;
            if (fullDate >= 19261225) return `昭和${year - 1925 === 1 ? '元' : year - 1925}年`;
            if (fullDate >= 19120730) return `大正${year - 1911 === 1 ? '元' : year - 1911}年`;
            if (fullDate >= 18680125) return `明治${year - 1867 === 1 ? '元' : year - 1867}年`;
            return `${year}年`;
        };

        const formatTime = (ms, formatMode = 'mm:ss') => {
            const totalSeconds = ms / 1000;
            if (formatMode === 'ss') return `${totalSeconds.toFixed(2)}秒`;
            const m = Math.floor(totalSeconds / 60);
            const s = (totalSeconds % 60).toFixed(2);
            return `${m}:${s.padStart(5, '0')}`;
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

        // --- Multi-language Map ---
        const translations = {
            ja: {
                appTitle: 'メモリープロ',
                calendar: 'カレンダー計算',
                number: 'ナンバー記憶',
                letter: 'レターペア',
                settings: 'アプリ設定',
                history: '履歴',
                lang: '表示言語',
                timerFormat: 'タイマー表示',
                minSec: '分:秒',
                onlySec: '秒',
                backup: 'データ管理',
                export: 'バックアップ作成 (保存)',
                import: 'データの復元 (読み込み)',
                reset: 'データを初期化',
                resetConfirm: '全ての履歴と設定を消去します。よろしいですか？',
                home: 'ホームへ',
                penaltyText: 'ミス1問につき30秒加算',
                start: 'スタート',
                back: '戻る',
                result: '結果確認',
                rawTime: 'タイム',
                penalty: 'ペナルティ',
                avgTime: '平均タイム',
                finalScore: 'スコア',
                retry: 'もう一度',
                changeRange: '出題範囲変更',
                gameSettings: '設定',
                countdown: '開始カウント',
                showNums: 'ボタン番号',
                digitPairs: '桁数',
                autoNext: '自動送り',
                autoNextOff: 'オフ',
                spacing: 'スペース区切り',
                range: '出題範囲',
                allRange: '全範囲',
                yearMode: '表示形式',
                western: '西暦',
                era: '和暦',
                both: '両方',
                next: '次へ',
                trainingType: '記憶術トレーニング',
                descCal: '曜日を素早く計算する訓練',
                descNum: '数字をイメージに変換する訓練',
                descLet: 'かな２文字を変換する訓練',
                recent: '最近',
                birthday: '誕生日',
                competition: '競技',
                restart: 'やり直す',
                register: '記録を登録',
                registered: '登録済み',
                bestScore: '最高記録',
                newRecord: '自己ベスト更新！',
                graph: '推移グラフ',
                confirmDiscard: '記録が登録されていません。破棄してもよろしいですか？',
                confirmQuit: '進行中のデータは破棄されます。よろしいですか？',
                noData: 'データがありません',
                sec: '秒',
                lap: 'ラップ'
            },
            en: {
                appTitle: 'MemoryPro',
                calendar: 'Calendar Calc',
                number: 'Number Memory',
                letter: 'Letter Pair',
                settings: 'Settings',
                history: 'History',
                lang: 'Language',
                timerFormat: 'Timer Format',
                minSec: 'MM:SS',
                onlySec: 'Sec',
                backup: 'Data Backup',
                export: 'Export Backup',
                import: 'Import Data',
                reset: 'Reset All',
                resetConfirm: 'Clear all history and settings?',
                home: 'Home',
                penaltyText: '30s penalty per mistake',
                start: 'Start',
                back: 'Back',
                result: 'Review',
                rawTime: 'Time',
                penalty: 'Penalty',
                avgTime: 'Avg',
                finalScore: 'Score',
                retry: 'Retry',
                changeRange: 'Change Range',
                gameSettings: 'Settings',
                countdown: 'Countdown',
                showNums: 'Index',
                digitPairs: 'Digits',
                autoNext: 'Auto',
                autoNextOff: 'Off',
                spacing: 'Spacing',
                range: 'Range',
                allRange: 'All',
                yearMode: 'Year Style',
                western: 'Western',
                era: 'Era',
                both: 'Both',
                next: 'Next',
                trainingType: 'Memory Training',
                descCal: 'Calculate day of week',
                descNum: 'Convert numbers to images',
                descLet: 'Convert letters to images',
                recent: 'Recent',
                birthday: 'Birthday',
                competition: 'Pro',
                restart: 'Restart',
                register: 'Register',
                registered: 'Registered',
                bestScore: 'Best',
                newRecord: 'New Best!',
                graph: 'Graph',
                confirmDiscard: 'Discard record?',
                confirmQuit: 'Data will be lost. Quit?',
                noData: 'No Data',
                sec: 's',
                lap: 'Lap'
            }
        };

        // --- Components ---

        const GlobalSettingsModal = ({ globalSettings, setGlobalSettings, onClose, t }) => {
            if (!t) return null; // Safety check

            const handleReset = () => { if (window.confirm(t.resetConfirm)) { localStorage.clear(); window.location.reload(); } };
            const handleExport = () => {
                const data = {
                    calendar_history: localStorage.getItem('calendar_history'),
                    calendar_records: localStorage.getItem('calendar_records'), 
                    memory_pro_numbers: localStorage.getItem('memory_pro_numbers'),
                    memory_pro_letters: localStorage.getItem('memory_pro_letters'),
                    calendar_settings: localStorage.getItem('calendar_settings'),
                    number_settings: localStorage.getItem('number_settings'),
                    global_settings: JSON.stringify(globalSettings)
                };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `memorypro_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.calendar_history) localStorage.setItem('calendar_history', data.calendar_history);
                        if (data.calendar_records) localStorage.setItem('calendar_records', data.calendar_records);
                        if (data.memory_pro_numbers) localStorage.setItem('memory_pro_numbers', data.memory_pro_numbers);
                        if (data.memory_pro_letters) localStorage.setItem('memory_pro_letters', data.memory_pro_letters);
                        if (data.calendar_settings) localStorage.setItem('calendar_settings', data.calendar_settings);
                        if (data.number_settings) localStorage.setItem('number_settings', data.number_settings);
                        if (data.global_settings) setGlobalSettings(JSON.parse(data.global_settings));
                        alert('インポート完了。'); window.location.reload();
                    } catch (err) { alert('不正なファイル形式です。'); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
                    <div className="bg-white w-full max-w-lg rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl p-6 overflow-y-auto max-h-[85vh] no-scrollbar">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <i className="fa-solid fa-sliders text-indigo-600"></i> {t.settings}
                            </h2>
                            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition-colors"><i className="fa-solid fa-xmark"></i></button>
                        </div>
                        <div className="space-y-6">
                            <section>
                                <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">{t.lang}</label>
                                <div className="grid grid-cols-2 gap-2">
                                    {['ja', 'en'].map(l => (
                                        <button key={l} onClick={() => setGlobalSettings(s => ({...s, lang: l}))} className={`py-3 rounded-xl border-2 font-bold text-sm transition-all ${globalSettings.lang === l ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-100 text-slate-400 hover:border-slate-200'}`}>
                                            {l === 'ja' ? '日本語' : 'English'}
                                        </button>
                                    ))}
                                </div>
                            </section>
                            <section>
                                <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">{t.backup}</label>
                                <div className="space-y-2">
                                    <button onClick={handleExport} className="w-full py-4 bg-slate-50 hover:bg-slate-100 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-colors"><i className="fa-solid fa-download"></i> {t.export}</button>
                                    <label className="w-full py-4 bg-slate-50 hover:bg-slate-100 rounded-xl font-bold text-sm flex items-center justify-center gap-2 cursor-pointer transition-colors"><i className="fa-solid fa-upload"></i> {t.import}<input type="file" accept=".json" onChange={handleImport} className="hidden" /></label>
                                    <button onClick={handleReset} className="w-full py-4 bg-red-50 text-red-500 rounded-xl font-bold text-sm border border-red-100 flex items-center justify-center gap-2 hover:bg-red-100 transition-colors">{t.reset}</button>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            );
        };

        const TrendGraph = ({ records, timerFormat, t }) => {
            if (!records || records.length === 0) return <div className="text-center text-slate-400 py-10 text-sm font-bold bg-slate-50 rounded-xl">{t.noData}</div>;

            const sortedRecords = [...records].sort((a, b) => a.timestamp - b.timestamp);
            const scores = sortedRecords.map(r => r.finalScore);
            
            const min = 0; // Fixed at 0 as requested
            const max = Math.max(...scores);
            const range = max || 1;
            
            const width = 300;
            const height = 180;
            const padding = 30;

            const points = scores.map((s, i) => {
                const x = padding + (i / (scores.length - 1 || 1)) * (width - padding * 2);
                const normalized = (s - min) / range; 
                const y = height - (padding + normalized * (height - padding * 2)); // Invert Y for correct orientation (SVG 0 is top)
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full flex flex-col items-center">
                    <svg width="100%" viewBox={`0 0 ${width} ${height}`} className="overflow-visible font-mono text-[8px] text-slate-400">
                        {/* Grid lines */}
                        <line x1={padding} y1={padding} x2={width-padding} y2={padding} stroke="#f1f5f9" strokeWidth="1" />
                        <text x={padding - 5} y={padding + 3} textAnchor="end">{formatTime(max, timerFormat)}</text>
                        
                        <line x1={padding} y1={height-padding} x2={width-padding} y2={height-padding} stroke="#f1f5f9" strokeWidth="1" />
                        <text x={padding - 5} y={height - padding + 3} textAnchor="end">{formatTime(min, timerFormat)}</text>
                        
                        <line x1={padding} y1={padding} x2={padding} y2={height-padding} stroke="#e2e8f0" strokeWidth="1" />
                        <line x1={padding} y1={height-padding} x2={width-padding} y2={height-padding} stroke="#e2e8f0" strokeWidth="1" />

                        {/* Data line */}
                        <polyline fill="none" stroke="#6366f1" strokeWidth="2" points={points} strokeLinejoin="round" />
                        
                        {/* Data points */}
                        {sortedRecords.map((r, i) => {
                             const s = r.finalScore;
                             const normalized = (s - min) / range;
                             const x = padding + (i / (scores.length - 1 || 1)) * (width - padding * 2);
                             const y = height - (padding + normalized * (height - padding * 2));
                             
                             return (
                                <g key={i}>
                                    <circle cx={x} cy={y} r="3" fill="#4f46e5" stroke="white" strokeWidth="1" />
                                </g>
                             );
                        })}
                    </svg>
                </div>
            );
        };

        const CalendarTrainer = ({ onBack, globalSettings, t }) => {
            const [gameState, setGameState] = useState('idle');
            const [isLocalSettingsOpen, setIsLocalSettingsOpen] = useState(false);
            const [isGraphOpen, setIsGraphOpen] = useState(false);
            const [selectedRange, setSelectedRange] = useState('recent');
            const [activeQuestion, setActiveQuestion] = useState(0);
            const [questions, setQuestions] = useState([]);
            const [laps, setLaps] = useState([]);
            const [startTime, setStartTime] = useState(0);
            const [currentTime, setCurrentTime] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [countdownText, setCountdownText] = useState('');
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('calendar_settings');
                return saved ? JSON.parse(saved) : { yearMode: 'western', countdownSeconds: 3, showNumbers: true, startDay: 0, timerFormat: 'mm:ss' };
            });
            const [currentSessionId, setCurrentSessionId] = useState(null);
            const [isRegistered, setIsRegistered] = useState(false);
            const [currentResult, setCurrentResult] = useState(null);

            const timerRef = useRef(null);

            const updateTimer = useCallback(() => {
                if (gameState === 'playing') {
                    setCurrentTime(performance.now());
                    timerRef.current = requestAnimationFrame(updateTimer);
                }
            }, [gameState]);

            useEffect(() => {
                if (gameState === 'playing') timerRef.current = requestAnimationFrame(updateTimer);
                else if (timerRef.current) cancelAnimationFrame(timerRef.current);
                return () => { if (timerRef.current) cancelAnimationFrame(timerRef.current); };
            }, [gameState, updateTimer]);

            const generateRandomDate = (range) => {
                let startYear, endYear;
                const now = new Date();
                if (range === 'birthday') { startYear = now.getFullYear() - 80; endYear = now.getFullYear(); }
                else if (range === 'competition') { startYear = 1500; endYear = 2500; }
                else { startYear = now.getFullYear() - 1; endYear = now.getFullYear() + 1; }
                const year = Math.floor(Math.random() * (endYear - startYear + 1)) + startYear;
                const month = Math.floor(Math.random() * 12);
                const day = Math.floor(Math.random() * 28) + 1;
                return new Date(year, month, day);
            };

            const startCountdown = (range) => {
                setSelectedRange(range); setLaps([]); setFeedback(null); setGameState('countdown');
                setIsRegistered(false); setCurrentResult(null); setCurrentSessionId(generateId());
                setQuestions(Array.from({ length: 5 }, () => generateRandomDate(range)));
                let count = settings.countdownSeconds;
                setCountdownText(count.toString());
                const interval = window.setInterval(() => {
                    count -= 1;
                    if (count === 0) setCountdownText('START!');
                    else if (count < 0) { clearInterval(interval); startTraining(); }
                    else setCountdownText(count.toString());
                }, 1000);
            };

            const startTraining = () => {
                setActiveQuestion(0); setGameState('playing');
                const now = performance.now(); setStartTime(now); setCurrentTime(now);
            };

            const handleAnswer = (dayIndex) => {
                if (gameState !== 'playing' || feedback) return;
                const targetDate = questions[activeQuestion];
                const correctDayIndex = targetDate.getDay();
                const isCorrect = dayIndex === correctDayIndex;
                const now = performance.now();
                const prevTotalDuration = laps.reduce((acc, l) => acc + l.duration, 0);
                const questionDuration = (now - startTime) - prevTotalDuration;

                const record = {
                    questionNumber: activeQuestion + 1,
                    date: formatDate(targetDate),
                    correct: isCorrect,
                    duration: questionDuration,
                    userAnswer: (globalSettings.lang === 'ja' ? DAYS_JP_LONG : DAYS_EN_LONG)[dayIndex],
                    correctAnswer: (globalSettings.lang === 'ja' ? DAYS_JP_LONG : DAYS_EN_LONG)[correctDayIndex]
                };
                setFeedback({ index: activeQuestion, isCorrect });
                setLaps(prev => [...prev, record]);
                setTimeout(() => {
                    setFeedback(null);
                    if (activeQuestion < 4) setActiveQuestion(prev => prev + 1);
                    else {
                        const finalTime = now - startTime;
                        const mistakes = [...laps, record].filter(l => !l.correct).length;
                        const session = { 
                            id: currentSessionId, 
                            timestamp: Date.now(), 
                            range: selectedRange, 
                            totalTime: finalTime, 
                            penaltySeconds: mistakes * 30, 
                            finalScore: finalTime + (mistakes * 30000), 
                            laps: [...laps, record], 
                            settings 
                        };
                        const history = JSON.parse(localStorage.getItem('calendar_history') || '[]');
                        history.unshift(session);
                        localStorage.setItem('calendar_history', JSON.stringify(history.slice(0, 100)));
                        setCurrentResult(session);
                        setGameState('finished');
                        
                        const records = JSON.parse(localStorage.getItem('calendar_records') || '[]');
                        const filtered = records.filter(r => r.range === selectedRange);
                        if (filtered.length === 0 || session.finalScore <= Math.min(...filtered.map(r => r.finalScore))) {
                            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                        }
                    }
                }, 300);
            };

            const handleRegister = (session) => {
                if (isRegistered) return;
                const records = JSON.parse(localStorage.getItem('calendar_records') || '[]');
                records.push(session);
                localStorage.setItem('calendar_records', JSON.stringify(records));
                setIsRegistered(true);
            };

            const getBestScore = (range) => {
                const records = JSON.parse(localStorage.getItem('calendar_records') || '[]');
                const filtered = records.filter(r => r.range === range);
                if (filtered.length === 0) return null;
                return Math.min(...filtered.map(r => r.finalScore));
            };

            const handleHomeClick = () => {
                if (gameState === 'playing' || gameState === 'countdown') {
                    if (window.confirm(t.confirmQuit)) onBack();
                } else if (gameState === 'finished' && !isRegistered) {
                    if (window.confirm(t.confirmDiscard)) onBack();
                } else {
                    onBack();
                }
            };

            const handleRetryCheck = (action) => {
                if (!isRegistered && gameState === 'finished') {
                    if (window.confirm(t.confirmDiscard)) action();
                } else action();
            };

            const formatDate = (date) => {
                const y = date.getFullYear(), m = date.getMonth() + 1, d = date.getDate(), era = getJapaneseEra(date);
                if (settings.yearMode === 'japanese') return `${era} ${m}月${d}日`;
                if (settings.yearMode === 'both') return `${y}年 (${era}) ${m}月${d}日`;
                return `${y}年 ${m}月${d}日`;
            };

            const updateLocalSettings = (key, val) => {
                const ns = {...settings, [key]: val};
                setSettings(ns);
                localStorage.setItem('calendar_settings', JSON.stringify(ns));
            };

            const dayList = useMemo(() => {
                const list = (globalSettings.lang === 'ja' ? DAYS_JP : DAYS_EN).map((label, index) => ({ label, index }));
                if (settings.startDay === 1) { const mon = list.slice(1); mon.push(list[0]); return mon; }
                return list;
            }, [settings.startDay, globalSettings.lang]);

            if (gameState === 'idle') {
                return (
                    <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                        <div className="flex justify-between items-center mb-6">
                            <button onClick={handleHomeClick} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-indigo-600 transition-colors"><i className="fa-solid fa-house"></i></button>
                            <h2 className="text-lg font-bold text-slate-800">{t.calendar}</h2>
                            <button onClick={() => setIsLocalSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-indigo-600 transition-colors"><i className="fa-solid fa-cog"></i></button>
                        </div>
                        <div className="flex-grow flex flex-col items-center justify-center text-center -mt-6">
                            <div className="mb-6 p-6 bg-indigo-50 rounded-full text-indigo-600 shadow-inner"><i className="fa-solid fa-calendar-days text-5xl"></i></div>
                            <p className="text-slate-500 text-xs mb-8 font-bold">{t.penaltyText}</p>
                            <div className="w-full space-y-3 max-w-sm mb-10">
                                {[{id:'recent',label:t.recent,desc:t.ja?'去年〜来年':'Last-Next Year',icon:'fa-clock'}, {id:'birthday',label:t.birthday,desc:t.ja?'過去80年':'Past 80Y',icon:'fa-cake-candles'}, {id:'competition',label:t.competition,desc:'1500-2500',icon:'fa-trophy'}].map(r => (
                                    <div key={r.id} className="relative">
                                        <button onClick={() => startCountdown(r.id)} className="w-full flex items-center p-4 bg-white border border-slate-100 rounded-2xl shadow-sm active:scale-95 transition-all pr-12 text-left">
                                            <div className="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 mr-4 transition-colors group-hover:bg-indigo-50 group-hover:text-indigo-500"><i className={`fa-solid ${r.icon}`}></i></div>
                                            <div>
                                                <div className="font-bold text-slate-800">{r.label}</div>
                                                <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{r.desc}</div>
                                            </div>
                                        </button>
                                        <button onClick={() => { setSelectedRange(r.id); setIsGraphOpen(true); }} className="absolute right-4 top-1/2 -translate-y-1/2 text-indigo-400 p-2 hover:text-indigo-600 transition-colors">
                                            <i className="fa-solid fa-chart-line"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {isLocalSettingsOpen && (
                            <div className="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl overflow-y-auto max-h-[80vh] no-scrollbar">
                                    <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-slate-800"><i className="fa-solid fa-cog text-indigo-500"></i> {t.gameSettings}</h3>
                                    <div className="space-y-5">
                                        <section>
                                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.countdown}</label>
                                            <div className="grid grid-cols-3 gap-2">
                                                {[3, 5, 10].map(s => (
                                                    <button key={s} onClick={() => updateLocalSettings('countdownSeconds', s)} className={`py-2.5 rounded-xl border-2 font-bold text-sm transition-all ${settings.countdownSeconds === s ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>{s}{t.sec}</button>
                                                ))}
                                            </div>
                                        </section>
                                        <section>
                                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.yearMode}</label>
                                            <div className="grid grid-cols-3 gap-2">
                                                {['western', 'japanese', 'both'].map(m => (
                                                    <button key={m} onClick={() => updateLocalSettings('yearMode', m)} className={`py-2.5 rounded-xl border-2 font-bold text-xs transition-all ${settings.yearMode === m ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>{m === 'japanese' ? t.era : t[m] || m}</button>
                                                ))}
                                            </div>
                                        </section>
                                        <section>
                                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.timerFormat}</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {['mm:ss', 'ss'].map(f => (
                                                    <button key={f} onClick={() => updateLocalSettings('timerFormat', f)} className={`py-2.5 rounded-xl border-2 font-bold text-xs transition-all ${settings.timerFormat === f ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>{f === 'mm:ss' ? t.minSec : t.onlySec}</button>
                                                ))}
                                            </div>
                                        </section>
                                        <section>
                                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block tracking-widest">{t.showNums}</label>
                                            <button onClick={() => updateLocalSettings('showNumbers', !settings.showNumbers)} className={`w-full py-3 rounded-xl border-2 font-bold text-sm transition-all ${settings.showNumbers ? 'bg-indigo-50 border-indigo-600 text-indigo-600' : 'border-slate-50 bg-slate-50 text-slate-400'}`}>{settings.showNumbers ? 'ON' : 'OFF'}</button>
                                        </section>
                                    </div>
                                    <button onClick={() => setIsLocalSettingsOpen(false)} className="w-full mt-8 py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-all">{t.back}</button>
                                </div>
                            </div>
                        )}
                        {isGraphOpen && (
                            <div className="fixed inset-0 z-[120] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                                <div className="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl">
                                    <div className="flex justify-between items-center mb-8">
                                        <h3 className="text-xl font-black flex items-center gap-2 text-slate-800">
                                            <i className="fa-solid fa-chart-line text-indigo-500"></i> {t.graph} 
                                            <span className="text-[10px] bg-indigo-50 px-3 py-1 rounded-full text-indigo-600 font-black uppercase tracking-widest ml-1">{t[selectedRange] || selectedRange}</span>
                                        </h3>
                                        <button onClick={() => setIsGraphOpen(false)} className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-2xl text-slate-500 hover:bg-slate-200 transition-colors"><i className="fa-solid fa-xmark"></i></button>
                                    </div>
                                    <TrendGraph records={JSON.parse(localStorage.getItem('calendar_records') || '[]').filter(r => r.range === selectedRange)} timerFormat={settings.timerFormat} t={t} />
                                    <button onClick={() => setIsGraphOpen(false)} className="w-full mt-10 py-4 bg-slate-900 text-white font-black rounded-2xl hover:bg-slate-800 transition-colors">{t.back}</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (gameState === 'countdown') return <div className="h-full flex items-center justify-center bg-indigo-600 text-white"><div className="text-8xl font-black animate-countdown px-4 text-center">{countdownText}</div></div>;

            if (gameState === 'playing') {
                return (
                    <div className="h-full flex flex-col p-4 overflow-hidden">
                        <div className="flex justify-between items-start mb-2 flex-none">
                            <button onClick={handleHomeClick} className="text-slate-400 hover:text-slate-600 py-2"><i className="fa-solid fa-house"></i></button>
                            <div className="flex flex-col items-center">
                                <span className="text-5xl font-mono font-black text-slate-800 tracking-tighter">{formatTime(currentTime - startTime, settings.timerFormat)}</span>
                            </div>
                            <button onClick={() => startCountdown(selectedRange)} className="text-slate-400 hover:text-slate-600 py-2 text-sm font-bold flex flex-col items-center gap-1 transition-colors"><i className="fa-solid fa-rotate-right"></i> {t.restart}</button>
                        </div>
                        <div className="text-center mb-4 flex-none">
                            <span className="text-[10px] font-black text-indigo-600 uppercase tracking-[0.2em]">{activeQuestion + 1} / 5</span>
                        </div>
                        <div className="space-y-2 overflow-y-auto no-scrollbar py-2 h-[45vh] flex-none">
                            {questions.map((q, idx) => {
                                const isAnswered = idx < laps.length;
                                const isActive = idx === activeQuestion;
                                return (
                                    <div key={idx} className={`p-4 rounded-2xl transition-all duration-300 ${isActive ? 'bg-indigo-50 scale-[1.02]' : isAnswered ? 'bg-slate-50 opacity-60' : 'opacity-20 blur-[1px]'}`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-6 h-6 rounded-full flex items-center justify-center font-bold text-[10px] ${isActive ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'}`}>{idx + 1}</div>
                                                <span className={`font-bold ${isActive ? 'text-lg' : 'text-sm'}`}>{isActive || isAnswered ? formatDate(q) : '????年??月??日'}</span>
                                            </div>
                                            {isAnswered && <i className={`fa-solid ${laps[idx].correct ? 'fa-circle-check text-green-500' : 'fa-circle-xmark text-red-400'}`}></i>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="flex-grow flex items-start justify-center pt-4">
                            <div className="grid grid-cols-7 gap-1 w-full max-w-sm">
                                {dayList.map(({ label, index }) => (
                                    <button key={label} onClick={() => handleAnswer(index)} className={`aspect-[3/4] flex flex-col items-center justify-center gap-1 rounded-xl shadow-sm border active:scale-95 transition-transform ${index === 0 ? 'text-red-500 bg-red-50 border-red-100' : index === 6 ? 'text-blue-500 bg-blue-50 border-blue-100' : 'bg-white border-slate-200 text-slate-700'}`}>
                                        <span className="font-bold text-lg sm:text-xl">{label}</span>
                                        {settings.showNumbers && <span className="text-[10px] font-black opacity-40">{index}</span>}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'finished') {
                if (!currentResult) return null;
                const avg = currentResult.totalTime / 5;
                const best = getBestScore(selectedRange);
                const isNewRecord = best !== null && currentResult.finalScore <= best;

                return (
                    <div className="h-full flex flex-col p-4 overflow-y-auto no-scrollbar">
                        <div className="flex justify-between items-center mb-6 pt-2">
                            <h2 className="text-2xl font-black flex items-center gap-3 text-slate-800"><i className="fa-solid fa-award text-amber-500"></i> {t.result}</h2>
                            <div className="flex gap-2">
                                <button onClick={() => setIsGraphOpen(true)} className="w-10 h-10 flex items-center justify-center bg-indigo-50 rounded-full text-indigo-600 shadow-sm transition-all hover:bg-indigo-100"><i className="fa-solid fa-chart-line"></i></button>
                                <button onClick={handleHomeClick} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm transition-all hover:text-indigo-600"><i className="fa-solid fa-house"></i></button>
                            </div>
                        </div>

                        {/* Redesigned Blue Score Card - Linear and Spaced */}
                        <div className="w-full bg-indigo-600 text-white rounded-[2.5rem] p-8 sm:p-10 mb-8 shadow-2xl relative flex flex-col items-center text-center">
                            {isNewRecord && (
                                <div className="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-[10px] font-black px-4 py-1.5 rounded-bl-2xl uppercase tracking-widest shadow-md">
                                    {t.newRecord}
                                </div>
                            )}
                            
                            {/* Final Score */}
                            <div className="text-[11px] font-black opacity-60 uppercase tracking-widest mb-1">{t.finalScore}</div>
                            <div className="text-6xl sm:text-7xl font-mono font-black mb-4 tracking-tighter drop-shadow-lg truncate w-full">
                                {formatTime(currentResult.finalScore, settings.timerFormat)}
                            </div>

                            {/* Best Score (Small Display) */}
                            <div className="flex items-center gap-2 mb-8 bg-black/10 px-4 py-1.5 rounded-full">
                                <i className="fa-solid fa-crown text-yellow-400 text-[10px]"></i>
                                <span className="text-xs font-black tracking-widest uppercase">{t.bestScore}: {best ? formatTime(best, settings.timerFormat) : '-'}</span>
                            </div>

                            {/* Register Action Button */}
                            <button 
                                onClick={() => handleRegister(currentResult)} 
                                disabled={isRegistered} 
                                className={`w-full py-5 rounded-[2rem] text-lg font-black flex items-center justify-center gap-3 mb-10 transition-all duration-300 ${isRegistered ? 'bg-white/20 text-white/50 cursor-default' : 'bg-white text-indigo-600 hover:scale-[1.02] active:scale-[0.98] shadow-xl'}`}
                            >
                                {isRegistered ? <><i className="fa-solid fa-check-double"></i> {t.registered}</> : <><i className="fa-solid fa-floppy-disk"></i> {t.register}</>}
                            </button>

                            {/* Detailed Stats Rows */}
                            <div className="w-full space-y-8 pt-8 border-t border-white/20">
                                {/* Row 1: Time Only */}
                                <div className="flex flex-col items-center">
                                    <div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.rawTime}</div>
                                    <div className="font-mono font-black text-3xl">{formatTime(currentResult.totalTime, settings.timerFormat)}</div>
                                </div>
                                {/* Row 2: Average and Penalty */}
                                <div className="grid grid-cols-2 w-full gap-4">
                                    <div className="flex flex-col items-center">
                                        <div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.avgTime}</div>
                                        <div className="font-mono font-black text-2xl tracking-tight">{formatTime(avg, 'ss')}</div>
                                    </div>
                                    <div className="flex flex-col items-center">
                                        <div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">{t.penalty}</div>
                                        <div className={`font-mono font-black text-2xl tracking-tight ${currentResult.penaltySeconds > 0 ? 'text-red-300' : 'text-green-300'}`}>+{currentResult.penaltySeconds}s</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* LAP DATA REVIEW */}
                        <div className="mb-10 space-y-4">
                            {currentResult.laps.map((lap, i) => (
                                <div key={i} className="bg-white rounded-3xl p-5 border border-slate-100 flex items-center justify-between shadow-sm hover:shadow-md transition-shadow">
                                    <div className="flex items-center gap-4">
                                        <div className={`w-8 h-8 rounded-2xl flex items-center justify-center font-black text-xs ${lap.correct ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{i + 1}</div>
                                        <div className="flex flex-col">
                                            <span className="text-[10px] text-slate-400 font-black tracking-wider mb-0.5 uppercase">{lap.date}</span>
                                            <span className="text-base font-bold text-slate-700">
                                                {lap.userAnswer} {!lap.correct && <span className="text-red-400 font-black ml-1">→ {lap.correctAnswer}</span>}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="flex flex-col items-end gap-1">
                                        <div className="text-xs font-mono font-black text-slate-400 tracking-tight">{formatTime(lap.duration, 'ss')}</div>
                                        {lap.correct ? <i className="fa-solid fa-circle-check text-green-500"></i> : <i className="fa-solid fa-circle-xmark text-red-400"></i>}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Actions */}
                        <div className="space-y-4 pb-12 mt-auto">
                            <button onClick={() => handleRetryCheck(() => startCountdown(selectedRange))} className="w-full py-6 bg-indigo-600 text-white text-xl font-black rounded-[2rem] shadow-lg hover:shadow-xl active:scale-95 transition-all">
                                <i className="fa-solid fa-rotate-right mr-3"></i> {t.retry}
                            </button>
                            <button onClick={() => handleRetryCheck(() => setGameState('idle'))} className="w-full py-6 bg-white border-2 border-slate-100 text-slate-600 text-xl font-black rounded-[2rem] active:scale-95 transition-all">
                                <i className="fa-solid fa-sliders mr-3"></i> {t.changeRange}
                            </button>
                        </div>
                    </div>
                );
            }
        };

        const NumberTrainer = ({ onBack, globalSettings, t }) => {
            const [gameState, setGameState] = useState('idle');
            const [currentValue, setCurrentValue] = useState('');
            const [isLocalSettingsOpen, setIsLocalSettingsOpen] = useState(false);
            const [history, setHistory] = useState([]);
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('number_settings');
                return saved ? JSON.parse(saved) : { digitPairs: 2, countdownSeconds: 3, spacing: true, autoNext: 0 };
            });
            const generate = useCallback(() => {
                let res = '';
                for (let i = 0; i < settings.digitPairs; i++) res += Math.floor(Math.random() * 10).toString();
                if (settings.spacing && settings.digitPairs === 4) return res.slice(0, 2) + ' ' + res.slice(2);
                return res;
            }, [settings]);

            const startCountdown = () => {
                setGameState('countdown');
                let count = settings.countdownSeconds || 3;
                const interval = setInterval(() => {
                    count--;
                    if (count < 0) { clearInterval(interval); setGameState('playing'); setCurrentValue(generate()); setHistory([]); }
                }, 1000);
            };

            const next = () => { setHistory(prev => [currentValue, ...prev].slice(0, 5)); setCurrentValue(generate()); };

            return (
                <div className="h-full flex flex-col p-4 relative">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={onBack} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-emerald-600 transition-colors"><i className="fa-solid fa-house"></i></button>
                        <h2 className="text-lg font-bold text-slate-800">{t.number}</h2>
                        <div className="w-10 h-10"></div>
                    </div>
                    {gameState === 'idle' ? (
                        <div className="flex-grow flex flex-col items-center justify-center -mt-10">
                            <div className="mb-6 p-6 bg-emerald-50 rounded-full text-emerald-600 shadow-inner"><i className="fa-solid fa-hashtag text-5xl"></i></div>
                            <button onClick={startCountdown} className="w-full max-w-sm py-5 bg-emerald-600 text-white font-bold rounded-2xl shadow-lg active:scale-95 text-xl transition-all hover:bg-emerald-700">{t.start}</button>
                        </div>
                    ) : (
                        <div className="flex-grow flex flex-col items-center justify-center py-4">
                            <div className="text-6xl sm:text-8xl font-mono font-black text-emerald-600 text-center break-all tracking-tighter">{currentValue}</div>
                            <div className="mt-20 w-full max-w-sm px-4">
                                <div className="flex flex-wrap justify-center gap-2 mb-8 h-10 overflow-hidden">
                                    {history.map((h, i) => <span key={i} className="px-2 py-1 bg-white text-slate-400 font-mono text-xs font-bold rounded-lg border border-slate-100">{h}</span>)}
                                </div>
                                <button onClick={next} className="w-full py-6 bg-emerald-600 text-white text-2xl font-black rounded-[2rem] shadow-xl active:scale-95 transition-all hover:bg-emerald-700">{t.next}</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const LetterPairTrainer = ({ onBack, globalSettings, t }) => {
            const [currentValue, setCurrentValue] = useState('あう');
            const gen = () => HIRAGANA_SET[Math.floor(Math.random() * HIRAGANA_SET.length)] + HIRAGANA_SET[Math.floor(Math.random() * HIRAGANA_SET.length)];
            return (
                <div className="h-full flex flex-col p-4">
                    <div className="flex justify-between items-center mb-10">
                        <button onClick={onBack} className="w-10 h-10 flex items-center justify-center bg-white rounded-full text-slate-500 shadow-sm hover:text-amber-600 transition-colors"><i className="fa-solid fa-house"></i></button>
                        <h2 className="text-lg font-bold text-slate-800">{t.letter}</h2>
                        <div className="w-10 h-10"></div>
                    </div>
                    <div className="flex-grow flex flex-col items-center justify-center -mt-10">
                        <div className="text-8xl font-black text-amber-600 tracking-widest text-center mb-16">{currentValue}</div>
                        <button onClick={() => setCurrentValue(gen())} className="w-full max-w-sm py-6 bg-amber-600 text-white text-2xl font-black rounded-[2rem] shadow-xl active:scale-95 transition-all hover:bg-amber-700">{t.next}</button>
                    </div>
                </div>
            );
        };

        const HomeView = ({ onSelectMode, onOpenSettings, t }) => {
            const modes = [
                { id: 'calendar', label: t.calendar, icon: 'fa-calendar-days', color: 'bg-indigo-500', desc: t.descCal },
                { id: 'number', label: t.number, icon: 'fa-hashtag', color: 'bg-emerald-500', desc: t.descNum },
                { id: 'letterpair', label: t.letter, icon: 'fa-language', color: 'bg-amber-500', desc: t.descLet }
            ];
            return (
                <div className="h-full flex flex-col p-6 overflow-y-auto no-scrollbar">
                    <div className="flex items-center justify-between mb-12 pt-2">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><i className="fa-solid fa-brain text-xl"></i></div>
                            <div>
                                <h1 className="text-xl font-black tracking-tight text-slate-800">{t.appTitle}</h1>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-tight">{t.trainingType}</p>
                            </div>
                        </div>
                        <button onClick={onOpenSettings} className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-slate-400 hover:text-indigo-600 shadow-sm border border-slate-100 transition-all"><i className="fa-solid fa-gear"></i></button>
                    </div>
                    <div className="space-y-5">
                        {modes.map(m => (
                            <button key={m.id} onClick={() => onSelectMode(m.id)} className="w-full bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm active:scale-95 transition-all flex items-center text-left hover:shadow-md">
                                <div className={`w-14 h-14 ${m.color} rounded-2xl flex items-center justify-center text-white shadow-md mr-5`}><i className={`fa-solid ${m.icon} text-xl`}></i></div>
                                <div className="flex-grow">
                                    <div className="font-black text-lg mb-0.5 text-slate-800">{m.label}</div>
                                    <div className="text-xs text-slate-400 font-bold tracking-tight">{m.desc}</div>
                                </div>
                                <i className="fa-solid fa-chevron-right text-slate-300 ml-2"></i>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('home');
            const [isGlobalSettingsOpen, setIsGlobalSettingsOpen] = useState(false);
            const [globalSettings, setGlobalSettings] = useState(() => {
                try {
                    const saved = localStorage.getItem('global_settings');
                    return saved ? JSON.parse(saved) : { lang: 'ja', theme: 'light' };
                } catch(e) {
                    return { lang: 'ja', theme: 'light' };
                }
            });
            
            useEffect(() => { 
                localStorage.setItem('global_settings', JSON.stringify(globalSettings)); 
            }, [globalSettings]);
            
            const t = translations[globalSettings.lang] || translations.ja;

            return (
                <main className="w-full h-full flex flex-col relative overflow-hidden bg-slate-50">
                    {mode === 'home' && (
                        <HomeView 
                            t={t} 
                            onSelectMode={setMode} 
                            onOpenSettings={() => setIsGlobalSettingsOpen(true)} 
                        />
                    )}
                    {mode === 'calendar' && <CalendarTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                    {mode === 'number' && <NumberTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                    {mode === 'letterpair' && <LetterPairTrainer t={t} globalSettings={globalSettings} onBack={() => setMode('home')} />}
                    
                    {isGlobalSettingsOpen && (
                        <GlobalSettingsModal 
                            globalSettings={globalSettings} 
                            setGlobalSettings={setGlobalSettings} 
                            onClose={() => setIsGlobalSettingsOpen(false)} 
                            t={t} 
                        />
                    )}
                </main>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>